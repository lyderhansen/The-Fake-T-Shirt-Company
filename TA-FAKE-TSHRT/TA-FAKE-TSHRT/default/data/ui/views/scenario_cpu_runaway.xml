<dashboard version="1.1" theme="dark">
  <label>CPU Runaway - SQL Backup Stuck</label>
  <description>32-hour SQL backup job causes 100% CPU on SQL-PROD-01</description>

  <fieldset submitButton="false">
    <input type="time" token="time" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>1735689600</earliest>
        <latest>1736899200</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <html>
        <div style="padding: 20px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d1f 100%); border-radius: 8px; border-left: 4px solid #f8be34;">
          <h2 style="color: #f8be34; margin-top: 0;">SQL Backup Job Stuck - CPU Runaway</h2>
          <p style="color: #ccc; font-size: 1.1em;">SQL backup job on SQL-PROD-01 gets stuck and causes 100% CPU utilization for 32 hours. DBA identifies and fixes the problem on Day 12 at 10:30.</p>
          <div style="display: flex; gap: 30px; margin-top: 15px; flex-wrap: wrap;">
            <div style="background: #333; padding: 10px 15px; border-radius: 5px;">
              <span style="color: #999;">Duration:</span> <strong style="color: #fff;">32 hours</strong>
            </div>
            <div style="background: #333; padding: 10px 15px; border-radius: 5px;">
              <span style="color: #999;">Category:</span> <strong style="color: #f8be34;">Operations</strong>
            </div>
            <div style="background: #333; padding: 10px 15px; border-radius: 5px;">
              <span style="color: #999;">demo_id:</span> <code style="color: #5CC05C;">cpu_runaway</code>
            </div>
            <div style="background: #333; padding: 10px 15px; border-radius: 5px;">
              <span style="color: #999;">Root Cause:</span> <strong style="color: #fff;">Backup hit locked table</strong>
            </div>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Target Server</title>
      <html>
        <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; border-left: 4px solid #f8be34;">
          <h3 style="color: #f8be34; margin-top: 0;">SQL-PROD-01</h3>
          <table style="width: 100%;">
            <tr><td style="color: #999; padding: 5px 0; width: 120px;">Hostname:</td><td style="color: #fff;"><strong>SQL-PROD-01</strong></td></tr>
            <tr><td style="color: #999; padding: 5px 0;">IP:</td><td style="color: #5CC05C;">10.10.20.30</td></tr>
            <tr><td style="color: #999; padding: 5px 0;">Location:</td><td style="color: #fff;">Boston</td></tr>
            <tr><td style="color: #999; padding: 5px 0;">OS:</td><td style="color: #fff;">Windows Server 2022</td></tr>
            <tr><td style="color: #999; padding: 5px 0;">Role:</td><td style="color: #fff;">Production SQL Database</td></tr>
          </table>
        </div>
      </html>
    </panel>
    <panel>
      <title>Timeline Summary</title>
      <html>
        <div style="background: #1a1a1a; padding: 15px; border-radius: 5px;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #2a2a2a;">
              <th style="padding: 8px; text-align: left; border: 1px solid #444;">Day/Time</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #444;">CPU %</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #444;">Event</th>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 11 02:00</td>
              <td style="padding: 8px; border: 1px solid #444;">40%</td>
              <td style="padding: 8px; border: 1px solid #444;">Backup job starts</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 11 08:00</td>
              <td style="padding: 8px; border: 1px solid #444;">65%</td>
              <td style="padding: 8px; border: 1px solid #444; color: #f8be34;">Users notice slowness</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 11 14:00</td>
              <td style="padding: 8px; border: 1px solid #444;">78%</td>
              <td style="padding: 8px; border: 1px solid #444; color: #f8be34;">Application timeouts start</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 12 02:00</td>
              <td style="padding: 8px; border: 1px solid #444;">94%</td>
              <td style="padding: 8px; border: 1px solid #444; color: #dc4e41;">Near full capacity</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 12 08:00</td>
              <td style="padding: 8px; border: 1px solid #444; color: #dc4e41;"><strong>100%</strong></td>
              <td style="padding: 8px; border: 1px solid #444; color: #dc4e41;"><strong>Full CPU saturation</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444; color: #5CC05C;"><strong>Day 12 10:30</strong></td>
              <td style="padding: 8px; border: 1px solid #444; color: #5CC05C;"><strong>30%</strong></td>
              <td style="padding: 8px; border: 1px solid #444; color: #5CC05C;"><strong>DBA kills job, restarts SQL</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #444;">Day 12 18:00</td>
              <td style="padding: 8px; border: 1px solid #444;">15%</td>
              <td style="padding: 8px; border: 1px solid #444;">Normal operation</td>
            </tr>
          </table>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Impact Chain</title>
      <html>
        <div style="background: #1a1a1a; padding: 20px; border-radius: 5px; text-align: center;">
          <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div style="background: #dc4e41; padding: 15px 25px; border-radius: 5px; color: #fff;">
              <strong>Backup Job Stuck</strong>
            </div>
            <div style="color: #444; font-size: 2em;">→</div>
            <div style="background: #dc4e41; padding: 15px 25px; border-radius: 5px; color: #fff;">
              <strong>CPU 100%</strong>
            </div>
            <div style="color: #444; font-size: 2em;">→</div>
            <div style="background: #f8be34; padding: 10px 15px; border-radius: 5px; color: #000;">
              Memory Pressure +25%<br/>
              Disk Queue 8x normal<br/>
              SQL Connection Timeouts
            </div>
            <div style="color: #444; font-size: 2em;">→</div>
            <div style="background: #dc4e41; padding: 15px 25px; border-radius: 5px; color: #fff;">
              <strong>Web Server 502 Errors</strong><br/>
              <span style="font-size: 0.9em;">Customer Impact</span>
            </div>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>CPU % Over Time (SQL-PROD-01)</title>
      <chart>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:Perfmon:*" host=SQL-PROD-01 counter="% Processor Time" demo_id=cpu_runaway
| timechart span=1h avg(Value) AS "CPU %"</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.drilldown">none</option>
        <option name="height">300</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">CPU %</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Peak CPU</title>
      <single>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:Perfmon:*" host=SQL-PROD-01 counter="% Processor Time" demo_id=cpu_runaway
| stats max(Value) AS "Peak CPU %"</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x5CC05C","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[70,90]</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0.0</option>
        <option name="unit">%</option>
      </single>
    </panel>
    <panel>
      <title>Total Events</title>
      <single>
        <search>
          <query>index=fake_tshrt demo_id=cpu_runaway | stats count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0xf8be34","0xf8be34"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>HTTP 5xx Errors</title>
      <single>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:access_combined" (status=502 OR status=503) demo_id=cpu_runaway | stats count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0xdc4e41","0xdc4e41"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Time to Fix</title>
      <single>
        <search>
          <query>| makeresults | eval hours="32 hrs" | table hours</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0xf8be34","0xf8be34"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>CPU vs Disk Queue Correlation</title>
      <chart>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:Perfmon:*" host=SQL-PROD-01
  (counter="% Processor Time" OR counter="Current Disk Queue Length")
  demo_id=cpu_runaway
| timechart span=1h avg(Value) by counter</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="height">250</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
    <panel>
      <title>HTTP Error Rate Over Time</title>
      <chart>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:access_combined" (status=502 OR status=503) demo_id=cpu_runaway
| timechart span=1h count AS errors</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="height">250</option>
        <option name="charting.fieldColors">{"errors": 0xdc4e41}</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>SQL Server Events</title>
      <table>
        <search>
          <query>index=fake_tshrt sourcetype="FAKE:WinEventLog" host=SQL-PROD-01 demo_id=cpu_runaway
  (EventID=17883 OR EventID=833 OR EventID=19406 OR EventID=17148 OR EventID=17147)
| eval EventDescription=case(
    EventID=17883, "Process appears to be non-yielding on CPU",
    EventID=833, "I/O requests taking longer than 15 seconds",
    EventID=19406, "Backup job is not responding",
    EventID=17148, "KILL command issued",
    EventID=17147, "SQL Server service restarted",
    true(), "Unknown"
)
| table _time, EventID, EventDescription, Message
| sort _time</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">15</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Investigation Queries</title>
      <html>
        <div style="background: #1a1a1a; padding: 20px; border-radius: 5px;">
          <h3 style="color: #5CC05C; margin-top: 0;">Ready-to-Use SPL Queries</h3>

          <h4 style="color: #ccc; margin-top: 20px;">CPU Over Time</h4>
          <pre style="background: #0d0d0d; padding: 10px; border-radius: 3px; overflow-x: auto; color: #5CC05C;">index=fake_tshrt sourcetype="FAKE:Perfmon:*" host=SQL-PROD-01
  counter="% Processor Time" demo_id=cpu_runaway
| timechart span=30m avg(Value) AS cpu</pre>

          <h4 style="color: #ccc; margin-top: 20px;">Disk Queue Correlation</h4>
          <pre style="background: #0d0d0d; padding: 10px; border-radius: 3px; overflow-x: auto; color: #5CC05C;">index=fake_tshrt sourcetype="FAKE:Perfmon:*" host=SQL-PROD-01
  (counter="% Processor Time" OR counter="Current Disk Queue Length")
  demo_id=cpu_runaway
| timechart span=1h avg(Value) by counter</pre>

          <h4 style="color: #ccc; margin-top: 20px;">SQL Server Errors</h4>
          <pre style="background: #0d0d0d; padding: 10px; border-radius: 3px; overflow-x: auto; color: #5CC05C;">index=fake_tshrt sourcetype="FAKE:WinEventLog" host=SQL-PROD-01
  (EventID=17883 OR EventID=833 OR EventID=19406) demo_id=cpu_runaway
| sort _time</pre>

          <h4 style="color: #ccc; margin-top: 20px;">Fix Events</h4>
          <pre style="background: #0d0d0d; padding: 10px; border-radius: 3px; overflow-x: auto; color: #5CC05C;">index=fake_tshrt sourcetype="FAKE:WinEventLog" host=SQL-PROD-01
  (EventID=17148 OR EventID=17147) demo_id=cpu_runaway
| table _time, EventID, Message</pre>

          <h4 style="color: #ccc; margin-top: 20px;">Error Correlation (CPU + HTTP)</h4>
          <pre style="background: #0d0d0d; padding: 10px; border-radius: 3px; overflow-x: auto; color: #5CC05C;">index=fake_tshrt demo_id=cpu_runaway
  (host=SQL-PROD-01 OR sourcetype="FAKE:access_combined")
| eval metric=case(
    sourcetype="FAKE:Perfmon:*" AND counter="% Processor Time", "CPU %",
    sourcetype="FAKE:access_combined" AND status>=500, "HTTP 5xx",
    true(), "other"
)
| timechart span=1h count by metric</pre>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Recent CPU Runaway Events</title>
      <table>
        <search>
          <query>index=fake_tshrt demo_id=cpu_runaway
| sort - _time
| table _time, sourcetype, host, counter, Value, EventID, status, message
| head 50</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>
</dashboard>
