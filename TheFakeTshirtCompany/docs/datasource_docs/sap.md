# SAP S/4HANA Audit Log

SAP audit log events from SAP-PROD-01, covering transactions, user activity, inventory, financials, and batch jobs correlated with e-commerce orders.

---

## Overview

| Attribute | Value |
|-----------|-------|
| Sourcetype | `sap:auditlog` |
| Format | Pipe-delimited |
| Output File | `output/erp/sap_audit.log` |
| Volume | ~200-500 events/day |
| Host | SAP-PROD-01 (10.10.20.60) |

---

## Key Fields

| Field | Description | Example |
|-------|-------------|---------|
| `timestamp` | Event time | `2026-01-05 14:23:45` |
| `host` | SAP server | `SAP-PROD-01` |
| `dialog_type` | Session type | `DIA` (dialog), `BTC` (batch), `RFC` |
| `user` | SAP username | `alex.miller` |
| `tcode` | Transaction code | `VA01` |
| `status` | Result | `S` (success), `E` (error), `W` (warning) |
| `description` | Action description | `Create Sales Order` |
| `doc_number` | Document reference | `SO-2026-00123` |
| `details` | Extended details | `3 items, total $234.56` |
| `demo_id` | Scenario tag | `dead_letter_pricing` |

---

## Transaction Codes

| T-Code | Name | Description |
|--------|------|-------------|
| VA01 | Create Sales Order | E-commerce order fulfillment |
| MIGO | Goods Movement | Goods receipt/issue, stock transfers |
| FB01 | Financial Posting | Invoice posting, journal entries |
| MM01 | Material Master | Product/material changes |
| VL01N | Delivery Creation | Outbound delivery |
| VF01 | Billing | Invoice creation |
| SM37 | Job Overview | Background job monitoring |
| SU01 | User Maintenance | User account changes |

---

## Event Categories

| Category | Frequency | Description |
|----------|-----------|-------------|
| Transaction execution | Business hours | VA01, MIGO, FB01, VL01N, VF01 |
| User activity | Business hours | Login, logout, failed login, password change |
| Inventory events | Business hours | Goods receipt, goods issue, stock transfer |
| Financial postings | Business hours | Invoice, payment run, GL journal entry |
| Batch jobs | 02:00-04:00 | Nightly MRP, posting period close |
| System events | Occasional | Transport import, job scheduling |

---

## Example Events

### Sales Order (correlated with web order)
```
2026-01-05 14:23:45|SAP-PROD-01|DIA|alex.miller|VA01|S|Create Sales Order|SO-2026-00123|Sales order for customer C-10042, 3 items, total $234.56
```

### Goods Receipt
```
2026-01-05 14:24:12|SAP-PROD-01|DIA|warehouse.user|MIGO|S|Goods Receipt 101|GM-2026-04567|Mvt 101: GR for PO, material M-0001 "Hack the Planet Tee", qty 500
```

### Nightly Batch Job
```
2026-01-05 02:00:05|SAP-PROD-01|BTC|sap.batch|SM37|S|Background Job Complete|MRP_NIGHTLY|MRP run completed, planned orders: 12, processing time: 847s
```

### Dead Letter Pricing (scenario-tagged)
```
2026-01-16 09:15:30|SAP-PROD-01|DIA|order.processor|VA01|S|Create Sales Order|SO-2026-01234|Sales order for customer C-10055, 2 items, total $89.00|demo_id=dead_letter_pricing
```

---

## Order Correlation

SAP reads from `order_registry.json` (generated by the access/orders generators) to create correlated sales orders. This means:

- Web order placed (access log) -> Order created (orders JSON) -> SAP VA01 (SAP audit)
- Orders with `scenario` field (e.g., `dead_letter_pricing`) are tagged with `demo_id` in SAP

---

## Use Cases

### 1. Transaction activity by T-code
```spl
index=erp sourcetype="sap:auditlog"
| stats count by tcode
| sort - count
```

### 2. Failed operations
```spl
index=erp sourcetype="sap:auditlog" status="E"
| stats count by user, tcode, description
| sort - count
```

### 3. Scenario-tagged orders
```spl
index=erp sourcetype="sap:auditlog" demo_id=dead_letter_pricing
| table _time, user, tcode, description, doc_number, details
```

### 4. Nightly batch job monitoring
```spl
index=erp sourcetype="sap:auditlog" dialog_type="BTC"
| table _time, user, tcode, description, details
```

### 5. User login audit
```spl
index=erp sourcetype="sap:auditlog" (description="*Login*" OR description="*Logon*")
| stats count by user, status
| sort - count
```

---

## Scenario Integration

| Scenario | Activity |
|----------|----------|
| **dead_letter_pricing** | VA01 sales orders tagged with `demo_id` when order has pricing scenario |

---

## Talking Points

**Order correlation:**
> "Every web order flows through to SAP. You can trace from the Apache access log click, to the retail order JSON, to the SAP VA01 sales order creation. During the dead letter pricing incident, the SAP orders show the wrong prices because the web store was serving stale data."

**Batch monitoring:**
> "SAP runs MRP nightly at 2 AM. If these batch jobs start failing or running longer than expected, it's an early indicator of infrastructure issues."

---

## Related Sources

- [Apache Access](access.md) - Web store traffic
- [Orders](orders.md) - Order creation
- [ServiceBus](servicebus.md) - Price update pipeline
- [ServiceNow](servicenow.md) - Incident tracking
