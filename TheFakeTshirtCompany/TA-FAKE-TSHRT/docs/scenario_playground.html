<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scenario Playground - FAKE T-Shirt Co</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a1a;
    --surface: #111127;
    --surface2: #1a1a36;
    --border: #252547;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --text3: #64748b;
    --attack: #ef4444;
    --attack-dim: #7f1d1d;
    --ops: #f59e0b;
    --ops-dim: #78350f;
    --network: #3b82f6;
    --network-dim: #1e3a5f;
    --cyan: #06b6d4;
    --green: #22c55e;
    --selection: #06b6d422;
    --radius: 6px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    overflow-x: hidden;
  }

  /* ── Layout ─────────────────────── */
  .app { display: flex; flex-direction: column; height: 100vh; }

  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .header h1 { font-size: 15px; font-weight: 600; letter-spacing: 0.5px; }
  .header h1 span { color: var(--cyan); }

  .presets { display: flex; gap: 6px; flex-wrap: wrap; }
  .preset-btn {
    padding: 4px 12px; font-size: 12px; font-weight: 500;
    border: 1px solid var(--border); border-radius: 20px;
    background: transparent; color: var(--text2); cursor: pointer;
    transition: all 0.15s;
  }
  .preset-btn:hover { border-color: var(--cyan); color: var(--text); }
  .preset-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); }

  .layout { display: flex; flex: 1; overflow: hidden; }

  /* ── Sidebar ────────────────────── */
  .sidebar {
    width: 260px; flex-shrink: 0;
    background: var(--surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
    display: flex; flex-direction: column; gap: 20px;
  }

  .panel-title {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text3); margin-bottom: 10px;
  }

  .category-label {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.2px; padding: 4px 0 6px; margin-top: 6px;
  }
  .category-label.attack { color: var(--attack); }
  .category-label.ops { color: var(--ops); }
  .category-label.network { color: var(--network); }

  .scenario-toggle {
    display: flex; align-items: center; gap: 8px;
    padding: 5px 8px; border-radius: var(--radius);
    cursor: pointer; transition: background 0.15s;
    font-size: 13px;
  }
  .scenario-toggle:hover { background: var(--surface2); }
  .scenario-toggle input { display: none; }

  .toggle-indicator {
    width: 14px; height: 14px; border-radius: 3px;
    border: 2px solid var(--border); flex-shrink: 0;
    transition: all 0.15s; position: relative;
  }
  .scenario-toggle input:checked + .toggle-indicator {
    border-color: var(--color);
    background: var(--color);
  }
  .scenario-toggle input:checked + .toggle-indicator::after {
    content: ''; position: absolute; top: 1px; left: 3px;
    width: 4px; height: 7px;
    border: solid #000; border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  .scenario-toggle .name { flex: 1; }
  .scenario-toggle .days-badge {
    font-size: 10px; color: var(--text3);
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
  }

  /* Config */
  .config-group { display: flex; flex-direction: column; gap: 12px; }
  .config-row { display: flex; flex-direction: column; gap: 4px; }
  .config-label {
    font-size: 12px; color: var(--text2);
    display: flex; justify-content: space-between;
  }
  .config-value {
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
    color: var(--cyan); font-weight: 600;
  }
  input[type="range"] {
    -webkit-appearance: none; width: 100%; height: 4px;
    background: var(--border); border-radius: 2px; outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    background: var(--cyan); border-radius: 50%; cursor: pointer;
  }

  .stats-row {
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .stat-chip {
    font-size: 11px; padding: 3px 8px; border-radius: 12px;
    background: var(--surface2); color: var(--text2);
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
  }
  .stat-chip strong { color: var(--text); }

  /* ── Content ────────────────────── */
  .content {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding: 20px;
    display: flex; flex-direction: column; gap: 20px;
  }

  .section { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); }
  .section-header {
    padding: 10px 16px; font-size: 12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--text2); border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
  }

  /* ── Heatmap ────────────────────── */
  .heatmap-row {
    display: flex; padding: 8px 16px 0; gap: 2px;
    align-items: flex-end;
  }
  .heatmap-label {
    width: 150px; flex-shrink: 0;
    font-size: 10px; color: var(--text3); text-align: right;
    padding-right: 10px; padding-bottom: 2px;
  }
  .heatmap-cell {
    flex: 1; height: 16px; border-radius: 2px;
    cursor: pointer; transition: all 0.1s;
    position: relative;
  }
  .heatmap-cell:hover { transform: scaleY(1.3); }
  .heatmap-cell.selected { outline: 2px solid var(--cyan); outline-offset: 1px; }

  /* ── Gantt ──────────────────────── */
  .gantt-body { padding: 0 16px 12px; }

  .gantt-days-header {
    display: flex; gap: 2px; margin-bottom: 4px;
  }
  .gantt-days-header .gantt-label { width: 150px; flex-shrink: 0; }
  .gantt-day-num {
    flex: 1; text-align: center; font-size: 9px; color: var(--text3);
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
    cursor: pointer; padding: 2px 0; border-radius: 2px;
  }
  .gantt-day-num:hover { color: var(--text); background: var(--surface2); }
  .gantt-day-num.selected { color: var(--cyan); font-weight: 700; }
  .gantt-day-num.outside { opacity: 0.3; }

  .gantt-cat-divider {
    display: flex; gap: 2px; padding: 6px 0 2px;
  }
  .gantt-cat-label {
    width: 150px; flex-shrink: 0; font-size: 9px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px; text-align: right;
    padding-right: 10px;
  }
  .gantt-cat-label.attack { color: var(--attack); }
  .gantt-cat-label.ops { color: var(--ops); }
  .gantt-cat-label.network { color: var(--network); }

  .gantt-row {
    display: flex; gap: 2px; margin-bottom: 2px; align-items: center;
    opacity: 1; transition: opacity 0.2s;
  }
  .gantt-row.disabled { opacity: 0.2; pointer-events: none; }

  .gantt-label {
    width: 150px; flex-shrink: 0; font-size: 11px;
    text-align: right; padding-right: 10px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    color: var(--text2);
  }

  .gantt-cell {
    flex: 1; height: 22px; border-radius: 2px;
    cursor: pointer; transition: all 0.1s;
    position: relative;
  }
  .gantt-cell.active { opacity: 0.85; }
  .gantt-cell.active:hover { opacity: 1; transform: scaleY(1.15); }
  .gantt-cell.active.selected { opacity: 1; outline: 2px solid #fff; outline-offset: -1px; }
  .gantt-cell.outside { opacity: 0.15 !important; }
  .gantt-cell.phase-start {
    border-left: 2px solid rgba(255,255,255,0.4);
  }

  /* phase tooltip */
  .gantt-cell .phase-tip {
    display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: var(--text); font-size: 11px;
    padding: 4px 8px; border-radius: 4px; white-space: nowrap;
    pointer-events: none; z-index: 10;
    border: 1px solid var(--border);
  }
  .gantt-cell:hover .phase-tip { display: block; }

  /* ── Day Detail ─────────────────── */
  .detail-body { padding: 16px; min-height: 80px; }
  .detail-empty { color: var(--text3); font-size: 13px; font-style: italic; }

  .detail-date {
    font-size: 14px; font-weight: 600; margin-bottom: 12px;
    display: flex; align-items: center; gap: 8px;
  }
  .detail-date .weekday { color: var(--text3); font-weight: 400; font-size: 12px; }

  .detail-cards { display: flex; flex-direction: column; gap: 10px; }
  .detail-card {
    padding: 12px 14px; border-radius: var(--radius);
    border-left: 3px solid var(--color);
    background: var(--surface2);
  }
  .detail-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 4px;
  }
  .detail-card-name { font-size: 13px; font-weight: 600; }
  .detail-card-phase {
    font-size: 11px; padding: 2px 8px; border-radius: 10px;
    font-weight: 600;
  }
  .detail-card-desc { font-size: 12px; color: var(--text2); margin-bottom: 6px; }
  .detail-card-meta {
    font-size: 11px; color: var(--text3);
    display: flex; gap: 16px; flex-wrap: wrap;
  }
  .detail-card-meta span { display: flex; align-items: center; gap: 4px; }

  /* ── Sources ────────────────────── */
  .sources-body { padding: 16px; }
  .source-group { margin-bottom: 12px; }
  .source-group-label {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text3); margin-bottom: 6px;
  }
  .source-chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .source-chip {
    font-size: 11px; padding: 3px 10px; border-radius: 12px;
    background: var(--surface2); color: var(--text3);
    border: 1px solid transparent;
    transition: all 0.15s; cursor: default;
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
  }
  .source-chip.active {
    color: var(--text); border-color: var(--border);
    background: var(--surface);
  }
  .source-chip.hot {
    border-color: var(--cyan); color: var(--cyan);
    background: rgba(6, 182, 212, 0.08);
  }
  .source-chip .count {
    font-size: 9px; font-weight: 700;
    margin-left: 4px; opacity: 0.7;
  }

  /* ── Prompt ─────────────────────── */
  .prompt-section {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 12px 20px;
    flex-shrink: 0;
  }
  .prompt-row {
    display: flex; gap: 12px; align-items: flex-start;
  }
  .prompt-text {
    flex: 1; font-size: 12px; line-height: 1.6;
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
    color: var(--text2); white-space: pre-wrap;
    background: var(--bg); padding: 10px 14px;
    border-radius: var(--radius); border: 1px solid var(--border);
    max-height: 120px; overflow-y: auto;
  }
  .prompt-text .cmd { color: var(--green); }
  .prompt-text .flag { color: var(--cyan); }
  .prompt-text .comment { color: var(--text3); }

  .copy-btn {
    padding: 8px 16px; font-size: 12px; font-weight: 600;
    border: 1px solid var(--cyan); border-radius: var(--radius);
    background: transparent; color: var(--cyan); cursor: pointer;
    white-space: nowrap; transition: all 0.15s;
    flex-shrink: 0;
  }
  .copy-btn:hover { background: var(--cyan); color: #000; }
  .copy-btn.copied { background: var(--green); border-color: var(--green); color: #000; }

  .prompt-desc {
    font-size: 11px; color: var(--text3); margin-top: 6px;
    line-height: 1.5;
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <h1><span>FAKE T-Shirt Co</span> &mdash; Scenario Playground</h1>
    <div class="presets">
      <button class="preset-btn active" data-preset="all">All (10)</button>
      <button class="preset-btn" data-preset="attack">Attack (3)</button>
      <button class="preset-btn" data-preset="ops">Ops (4)</button>
      <button class="preset-btn" data-preset="network">Network (3)</button>
      <button class="preset-btn" data-preset="week1">Week 1</button>
      <button class="preset-btn" data-preset="week2">Week 2</button>
      <button class="preset-btn" data-preset="none">None</button>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="panel-title">Scenarios</div>
        <div id="scenario-toggles"></div>
      </div>

      <div>
        <div class="panel-title">Configuration</div>
        <div class="config-group">
          <div class="config-row">
            <div class="config-label">Generation Days <span class="config-value" id="days-val">31</span></div>
            <input type="range" id="days-slider" min="1" max="31" value="31">
          </div>
          <div class="config-row">
            <div class="config-label">Scale <span class="config-value" id="scale-val">1.0</span></div>
            <input type="range" id="scale-slider" min="1" max="30" value="10" step="1">
          </div>
        </div>
      </div>

      <div>
        <div class="panel-title">Summary</div>
        <div class="stats-row" id="stats"></div>
      </div>
    </aside>

    <!-- Content -->
    <main class="content">
      <!-- Timeline -->
      <div class="section">
        <div class="section-header">
          <span>January 2026 Timeline</span>
          <span id="timeline-hint" style="font-size:10px;color:var(--text3);text-transform:none;letter-spacing:0;font-weight:400;">Click a day for details</span>
        </div>
        <div class="heatmap-row" id="heatmap"></div>
        <div class="gantt-body" id="gantt"></div>
      </div>

      <!-- Day Detail -->
      <div class="section">
        <div class="section-header">
          <span>Day Detail</span>
          <span id="detail-count" style="font-size:10px;color:var(--text3);text-transform:none;letter-spacing:0;font-weight:400;"></span>
        </div>
        <div class="detail-body" id="detail">
          <div class="detail-empty">Select a day on the timeline to see active scenario details</div>
        </div>
      </div>

      <!-- Sources -->
      <div class="section">
        <div class="section-header">
          <span>Affected Log Sources</span>
          <span id="source-count" style="font-size:10px;color:var(--text3);text-transform:none;letter-spacing:0;font-weight:400;"></span>
        </div>
        <div class="sources-body" id="sources"></div>
      </div>
    </main>
  </div>

  <!-- Prompt -->
  <div class="prompt-section">
    <div class="prompt-row">
      <div>
        <div class="prompt-text" id="prompt"></div>
        <div class="prompt-desc" id="prompt-desc"></div>
      </div>
      <button class="copy-btn" id="copy-btn">Copy Command</button>
    </div>
  </div>

</div>

<script>
// ── Scenario Data ──────────────────────────────────────
const SCENARIOS = {
  exfil: {
    name: "Data Exfiltration (APT)",
    short: "Exfil",
    category: "attack",
    color: "#ef4444",
    startDay: 1, endDay: 14,
    target: "Alex Miller (BOS, Finance)",
    via: "Jessica Brown (ATL, IT Admin)",
    server: "Multiple (cross-site)",
    phases: [
      { s:1, e:3, name:"Recon", desc:"Port scanning, phishing emails sent" },
      { s:4, e:4, name:"Initial Access", desc:"Jessica Brown clicks phishing link (Atlanta)" },
      { s:5, e:7, name:"Lateral Movement", desc:"Cross-site probing ATL to BOS, privilege escalation" },
      { s:8, e:10, name:"Persistence", desc:"Backdoor creation, data staging on file server" },
      { s:11, e:14, name:"Exfiltration", desc:"Financial data theft via AWS S3 and GCP Storage" }
    ],
    sources: ["asa","entraid","aws","gcp","perfmon","wineventlog","exchange","office_audit","servicenow","mssql","sysmon","secure_access","catalyst","aci","webex","linux"],
    description: "APT-style attack: Atlanta IT admin compromised via phishing, lateral movement to Boston, exfiltration of financial data over 14 days."
  },
  ransomware_attempt: {
    name: "Ransomware (Detected)",
    short: "Ransomware",
    category: "attack",
    color: "#f87171",
    startDay: 8, endDay: 9,
    target: "Brooklyn White (AUS, Sales)",
    server: null,
    phases: [
      { s:8, e:8, name:"Delivery & Detection", desc:"Phishing email, macro executes, C2 callback, EDR detects in 10 min" },
      { s:9, e:9, name:"Containment", desc:"Machine isolated, malware removed, forensics" }
    ],
    sources: ["asa","exchange","wineventlog","meraki","servicenow","office_audit","sysmon","secure_access"],
    description: "Ransomware attempt via phishing email targeting Austin sales engineer. Detected by EDR in 10 minutes, machine isolated."
  },
  phishing_test: {
    name: "Phishing Awareness Test",
    short: "Phishing Test",
    category: "attack",
    color: "#fca5a5",
    startDay: 21, endDay: 23,
    target: "All 175 employees",
    server: null,
    phases: [
      { s:21, e:21, name:"Wave Deployment", desc:"3 waves: BOS 9AM, ATL 10AM, AUS 11AM" },
      { s:22, e:22, name:"Click Tracking", desc:"31% click rate, 10% submit credentials" },
      { s:23, e:23, name:"Training", desc:"Awareness training for clickers" }
    ],
    sources: ["exchange","entraid","wineventlog","office_audit","servicenow","secure_access"],
    description: "IT-run phishing awareness campaign (post-exfil incident). 31% click rate, 10% credential submission."
  },
  memory_leak: {
    name: "Memory Leak (OOM)",
    short: "Mem Leak",
    category: "ops",
    color: "#f59e0b",
    startDay: 7, endDay: 10,
    target: null,
    server: "WEB-01 (172.16.1.10)",
    phases: [
      { s:7, e:8, name:"Gradual Leak", desc:"Memory 55% to 75%, swap usage climbing" },
      { s:9, e:9, name:"Critical", desc:"Memory 96-99%, severe swapping, app timeouts" },
      { s:10, e:10, name:"OOM & Recovery", desc:"Crash at 14:00, restart at 14:05, back to 50%" }
    ],
    sources: ["linux","asa","access","servicenow","catalyst_center","aws"],
    description: "Gradual memory leak in WEB-01 nginx. Memory climbs to 99%, OOM crash on Day 10, manual restart."
  },
  cpu_runaway: {
    name: "CPU Runaway (Backup)",
    short: "CPU Runaway",
    category: "ops",
    color: "#fbbf24",
    startDay: 11, endDay: 12,
    target: null,
    server: "SQL-PROD-01 (10.10.20.30)",
    phases: [
      { s:11, e:11, name:"Stuck Backup", desc:"Backup starts 02:00, CPU climbs to 90% by evening" },
      { s:12, e:12, name:"Critical & Fix", desc:"100% CPU at peak, DBA kills job at 10:30, normalizes" }
    ],
    sources: ["perfmon","wineventlog","asa","access","servicenow","mssql","aci","catalyst_center","aws","gcp"],
    description: "SQL backup job stuck at 100% CPU. DB connection failures cascade to web errors. DBA manually fixes."
  },
  disk_filling: {
    name: "Disk Filling",
    short: "Disk Fill",
    category: "ops",
    color: "#fb923c",
    startDay: 1, endDay: 5,
    target: null,
    server: "MON-ATL-01 (10.20.20.30)",
    phases: [
      { s:1, e:2, name:"Growth", desc:"Disk 45% to 65% from verbose logging" },
      { s:3, e:3, name:"Warning", desc:"Disk 70-80%, threshold alerts fire" },
      { s:4, e:4, name:"Critical", desc:"Disk 85-95%, I/O contention, alerts escalate" },
      { s:5, e:5, name:"Emergency & Fix", desc:"97% peak, cleanup script at 10:00 restores to 43%" }
    ],
    sources: ["linux","access","servicenow"],
    description: "Atlanta monitoring server disk fills from verbose logging. 45% to 97% over 5 days, cleanup script resolves."
  },
  dead_letter_pricing: {
    name: "Dead Letter Queue",
    short: "DLQ Pricing",
    category: "ops",
    color: "#e879f9",
    startDay: 16, endDay: 16,
    target: null,
    server: "WEB-01 (172.16.1.10)",
    phases: [
      { s:16, e:16, name:"DLQ Incident", desc:"Consumer crashes 08:00, wrong prices for 4-5 hours, fixed by 13:00" }
    ],
    sources: ["servicebus","orders","access","servicenow"],
    description: "ServiceBus consumer crash causes dead-letter queue buildup. 60% of products show wrong prices for 4-5 hours."
  },
  ddos_attack: {
    name: "DDoS Attack",
    short: "DDoS",
    category: "network",
    color: "#3b82f6",
    startDay: 18, endDay: 19,
    target: null,
    server: "WEB-01/WEB-02 (DMZ)",
    phases: [
      { s:18, e:18, name:"Attack & Response", desc:"02:00 probing, 08:00 full flood, 10:00 Wave 1 blocked, 12:00 Wave 2" },
      { s:19, e:19, name:"Mitigation", desc:"ISP filtering at 14:00, subsides 18:00, fully stopped by 06:00" }
    ],
    sources: ["asa","meraki","access","perfmon","linux","servicenow","catalyst","aci","catalyst_center","aws"],
    description: "Volumetric HTTP flood from global botnet (20 IPs, 2 waves). Emergency ACLs + ISP filtering mitigate."
  },
  firewall_misconfig: {
    name: "Firewall Misconfiguration",
    short: "FW Misconfig",
    category: "network",
    color: "#60a5fa",
    startDay: 6, endDay: 6,
    target: null,
    server: "FW-EDGE-01 (ASA 5525-X)",
    phases: [
      { s:6, e:6, name:"Misconfiguration", desc:"10:15 wrong ACL applied, 2-hour outage, rollback at 12:05" }
    ],
    sources: ["asa","access","servicenow","catalyst"],
    description: "Admin blocks TO web server instead of FROM threat IP. 2-hour customer-facing outage from human error."
  },
  certificate_expiry: {
    name: "Certificate Expiry",
    short: "Cert Expiry",
    category: "network",
    color: "#93c5fd",
    startDay: 13, endDay: 13,
    target: null,
    server: "FW-EDGE-01",
    phases: [
      { s:13, e:13, name:"Cert Expired", desc:"00:00 cert expires, 06:15 NOC notices, 07:00 new cert installed" }
    ],
    sources: ["asa","access","servicenow"],
    description: "Wildcard SSL cert expires at midnight. 7-hour HTTPS outage until emergency renewal."
  }
};

const SOURCE_GROUPS = {
  "Network": ["asa","meraki","catalyst","aci"],
  "Cloud / Security": ["aws","gcp","entraid","secure_access","catalyst_center"],
  "Windows": ["perfmon","wineventlog","sysmon","mssql"],
  "Linux": ["linux"],
  "Web / Retail": ["access","orders","servicebus"],
  "Collaboration": ["exchange","office_audit","webex"],
  "ITSM": ["servicenow"]
};

const CATEGORY_ORDER = ["attack","ops","network"];
const CATEGORY_NAMES = { attack: "Attack", ops: "Operations", network: "Network" };
const DAYS_IN_MONTH = 31;

const WEEKDAYS = ["Thu","Fri","Sat","Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

// ── State ──────────────────────────────────────────────
const state = {
  selected: new Set(Object.keys(SCENARIOS)),
  selectedDay: null,
  days: 31,
  scale: 1.0
};

// ── Init ───────────────────────────────────────────────
function init() {
  buildToggles();
  buildGantt();
  buildSources();
  updateAll();
  bindEvents();
}

function buildToggles() {
  const container = document.getElementById('scenario-toggles');
  let html = '';
  for (const cat of CATEGORY_ORDER) {
    html += `<div class="category-label ${cat}">${CATEGORY_NAMES[cat]}</div>`;
    for (const [id, s] of Object.entries(SCENARIOS)) {
      if (s.category !== cat) continue;
      html += `
        <label class="scenario-toggle" style="--color:${s.color}" data-id="${id}">
          <input type="checkbox" ${state.selected.has(id) ? 'checked' : ''}>
          <span class="toggle-indicator"></span>
          <span class="name">${s.short}</span>
          <span class="days-badge">D${s.startDay}${s.endDay !== s.startDay ? '-'+s.endDay : ''}</span>
        </label>`;
    }
  }
  container.innerHTML = html;
}

function buildGantt() {
  const gantt = document.getElementById('gantt');
  const heatmap = document.getElementById('heatmap');

  // Heatmap
  let hm = '<div class="heatmap-label">Activity</div>';
  for (let d = 1; d <= DAYS_IN_MONTH; d++) {
    hm += `<div class="heatmap-cell" data-day="${d}" title="Day ${d}"></div>`;
  }
  heatmap.innerHTML = hm;

  // Day numbers header
  let html = '<div class="gantt-days-header"><div class="gantt-label"></div>';
  for (let d = 1; d <= DAYS_IN_MONTH; d++) {
    html += `<div class="gantt-day-num" data-day="${d}">${d}</div>`;
  }
  html += '</div>';

  // Scenario rows grouped by category
  for (const cat of CATEGORY_ORDER) {
    html += `<div class="gantt-cat-divider"><div class="gantt-cat-label ${cat}">${CATEGORY_NAMES[cat]}</div>`;
    for (let d = 1; d <= DAYS_IN_MONTH; d++) html += '<div style="flex:1"></div>';
    html += '</div>';

    for (const [id, s] of Object.entries(SCENARIOS)) {
      if (s.category !== cat) continue;
      html += `<div class="gantt-row" data-scenario="${id}"><div class="gantt-label">${s.short}</div>`;
      for (let d = 1; d <= DAYS_IN_MONTH; d++) {
        const active = d >= s.startDay && d <= s.endDay;
        const phase = active ? getPhase(s, d) : null;
        const isPhaseStart = phase && d === phase.s && d !== s.startDay;
        let cls = 'gantt-cell';
        if (active) cls += ' active';
        if (isPhaseStart) cls += ' phase-start';

        const tip = phase ? `<span class="phase-tip">${phase.name}: ${phase.desc}</span>` : '';
        const bg = active ? `background:${s.color}` : '';
        html += `<div class="${cls}" data-day="${d}" data-scenario="${id}" style="${bg}">${tip}</div>`;
      }
      html += '</div>';
    }
  }
  gantt.innerHTML = html;
}

function buildSources() {
  const container = document.getElementById('sources');
  let html = '';
  for (const [group, sources] of Object.entries(SOURCE_GROUPS)) {
    html += `<div class="source-group"><div class="source-group-label">${group}</div><div class="source-chips">`;
    for (const src of sources) {
      html += `<div class="source-chip" data-source="${src}">${src}<span class="count"></span></div>`;
    }
    html += '</div></div>';
  }
  container.innerHTML = html;
}

// ── Update ─────────────────────────────────────────────
function updateAll() {
  updateGantt();
  updateHeatmap();
  updateDetail();
  updateSources();
  updateStats();
  updatePrompt();
}

function updateGantt() {
  // Toggle row visibility
  document.querySelectorAll('.gantt-row').forEach(row => {
    const id = row.dataset.scenario;
    row.classList.toggle('disabled', !state.selected.has(id));
  });

  // Mark outside-generation-window cells
  document.querySelectorAll('.gantt-cell, .gantt-day-num').forEach(el => {
    const d = parseInt(el.dataset.day);
    el.classList.toggle('outside', d > state.days);
  });

  // Selected day highlight
  document.querySelectorAll('.gantt-day-num, .heatmap-cell').forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.day) === state.selectedDay);
  });
  document.querySelectorAll('.gantt-cell.active').forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.day) === state.selectedDay);
  });
}

function updateHeatmap() {
  for (let d = 1; d <= DAYS_IN_MONTH; d++) {
    const count = getActiveCount(d);
    const cell = document.querySelector(`.heatmap-cell[data-day="${d}"]`);
    const intensity = count === 0 ? 0 : 0.2 + (count / 4) * 0.8;
    const outside = d > state.days;

    let color;
    if (count === 0) color = 'var(--surface2)';
    else if (count === 1) color = `rgba(6,182,212,${intensity * (outside ? 0.15 : 1)})`;
    else if (count === 2) color = `rgba(251,191,36,${intensity * (outside ? 0.15 : 1)})`;
    else color = `rgba(239,68,68,${intensity * (outside ? 0.15 : 1)})`;

    cell.style.background = color;
    cell.title = `Day ${d} (${getDateStr(d)}): ${count} active scenario${count !== 1 ? 's' : ''}`;
    cell.classList.toggle('outside', outside);
    if (outside) cell.style.opacity = '0.25';
    else cell.style.opacity = '1';
  }
}

function updateDetail() {
  const container = document.getElementById('detail');
  const countEl = document.getElementById('detail-count');

  if (!state.selectedDay) {
    container.innerHTML = '<div class="detail-empty">Select a day on the timeline to see active scenario details</div>';
    countEl.textContent = '';
    return;
  }

  const d = state.selectedDay;
  const active = getActiveScenarios(d);
  const dateStr = getDateStr(d);
  const outside = d > state.days;

  countEl.textContent = `${active.length} scenario${active.length !== 1 ? 's' : ''} active`;

  let html = `<div class="detail-date">January ${d}, 2026 <span class="weekday">${WEEKDAYS[d-1]}${outside ? ' (outside generation window)' : ''}</span></div>`;

  if (active.length === 0) {
    html += '<div class="detail-empty">No active scenarios on this day</div>';
  } else {
    html += '<div class="detail-cards">';
    for (const id of active) {
      const s = SCENARIOS[id];
      const phase = getPhase(s, d);
      const phaseColor = s.color;

      html += `<div class="detail-card" style="--color:${s.color}">
        <div class="detail-card-header">
          <span class="detail-card-name" style="color:${s.color}">${s.name}</span>
          ${phase ? `<span class="detail-card-phase" style="background:${s.color}22;color:${s.color}">${phase.name}</span>` : ''}
        </div>
        ${phase ? `<div class="detail-card-desc">${phase.desc}</div>` : ''}
        <div class="detail-card-meta">
          ${s.target ? `<span>Target: ${s.target}</span>` : ''}
          ${s.server ? `<span>Server: ${s.server}</span>` : ''}
          <span>Day ${d} of ${s.endDay - s.startDay + 1}</span>
          <span>${s.sources.length} sources</span>
        </div>
      </div>`;
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

function updateSources() {
  // Count how many selected scenarios use each source
  const counts = {};
  for (const id of state.selected) {
    for (const src of SCENARIOS[id].sources) {
      counts[src] = (counts[src] || 0) + 1;
    }
  }

  const totalSources = Object.keys(counts).length;
  document.getElementById('source-count').textContent = `${totalSources} sources from ${state.selected.size} scenarios`;

  document.querySelectorAll('.source-chip').forEach(chip => {
    const src = chip.dataset.source;
    const count = counts[src] || 0;
    chip.classList.toggle('active', count > 0);
    chip.classList.toggle('hot', count >= 3);
    chip.querySelector('.count').textContent = count > 0 ? `(${count})` : '';
  });
}

function updateStats() {
  const active = state.selected.size;
  const byCat = { attack: 0, ops: 0, network: 0 };
  const allSources = new Set();
  let inWindow = 0;

  for (const id of state.selected) {
    const s = SCENARIOS[id];
    byCat[s.category]++;
    s.sources.forEach(src => allSources.add(src));
    if (s.startDay <= state.days) inWindow++;
  }

  document.getElementById('stats').innerHTML = `
    <div class="stat-chip"><strong>${active}</strong> scenarios</div>
    <div class="stat-chip"><strong>${inWindow}</strong> in window</div>
    <div class="stat-chip"><strong>${allSources.size}</strong> sources</div>
    <div class="stat-chip" style="color:var(--attack)"><strong>${byCat.attack}</strong> attack</div>
    <div class="stat-chip" style="color:var(--ops)"><strong>${byCat.ops}</strong> ops</div>
    <div class="stat-chip" style="color:var(--network)"><strong>${byCat.network}</strong> net</div>
  `;
}

function updatePrompt() {
  const promptEl = document.getElementById('prompt');
  const descEl = document.getElementById('prompt-desc');

  if (state.selected.size === 0) {
    promptEl.innerHTML = '<span class="cmd">python3 bin/main_generate.py</span> <span class="flag">--all --scenarios=none --days=' + state.days + '</span>';
    descEl.textContent = 'Baseline traffic only, no scenarios injected.';
    return;
  }

  // Determine scenario flag
  const ids = [...state.selected].sort();
  const allIds = Object.keys(SCENARIOS).sort();
  const attackIds = allIds.filter(id => SCENARIOS[id].category === 'attack');
  const opsIds = allIds.filter(id => SCENARIOS[id].category === 'ops');
  const networkIds = allIds.filter(id => SCENARIOS[id].category === 'network');

  let scenarioFlag;
  if (ids.join(',') === allIds.join(',')) scenarioFlag = 'all';
  else if (ids.join(',') === attackIds.join(',')) scenarioFlag = 'attack';
  else if (ids.join(',') === opsIds.join(',')) scenarioFlag = 'ops';
  else if (ids.join(',') === networkIds.join(',')) scenarioFlag = 'network';
  else scenarioFlag = ids.join(',');

  // Build command
  let cmd = `<span class="cmd">python3 bin/main_generate.py</span> <span class="flag">--all --scenarios=${scenarioFlag} --days=${state.days}</span>`;
  if (state.scale !== 1.0) cmd += ` <span class="flag">--scale=${state.scale}</span>`;

  // Active vs excluded
  const inWindow = ids.filter(id => SCENARIOS[id].startDay <= state.days);
  const excluded = ids.filter(id => SCENARIOS[id].startDay > state.days);

  let desc = `Generates ${state.days} day${state.days > 1 ? 's' : ''} (Jan 1-${state.days}) with ${inWindow.length} active scenario${inWindow.length !== 1 ? 's' : ''}.`;

  if (excluded.length > 0) {
    desc += ` Note: ${excluded.map(id => SCENARIOS[id].short).join(', ')} start${excluded.length === 1 ? 's' : ''} after day ${state.days} and won't generate events.`;
  }

  promptEl.innerHTML = cmd;
  descEl.textContent = desc;
}

// ── Helpers ────────────────────────────────────────────
function getPhase(scenario, day) {
  for (const p of scenario.phases) {
    if (day >= p.s && day <= p.e) return p;
  }
  return null;
}

function getActiveCount(day) {
  let count = 0;
  for (const id of state.selected) {
    const s = SCENARIOS[id];
    if (day >= s.startDay && day <= s.endDay) count++;
  }
  return count;
}

function getActiveScenarios(day) {
  const active = [];
  for (const id of state.selected) {
    const s = SCENARIOS[id];
    if (day >= s.startDay && day <= s.endDay) active.push(id);
  }
  return active;
}

function getDateStr(day) {
  return `Jan ${day}, 2026`;
}

// ── Events ─────────────────────────────────────────────
function bindEvents() {
  // Scenario toggles
  document.getElementById('scenario-toggles').addEventListener('change', e => {
    if (e.target.type !== 'checkbox') return;
    const id = e.target.closest('.scenario-toggle').dataset.id;
    if (e.target.checked) state.selected.add(id);
    else state.selected.delete(id);
    updatePresetHighlight();
    updateAll();
  });

  // Presets
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const preset = btn.dataset.preset;
      state.selected.clear();
      if (preset === 'all') Object.keys(SCENARIOS).forEach(id => state.selected.add(id));
      else if (preset === 'attack') Object.keys(SCENARIOS).filter(id => SCENARIOS[id].category === 'attack').forEach(id => state.selected.add(id));
      else if (preset === 'ops') Object.keys(SCENARIOS).filter(id => SCENARIOS[id].category === 'ops').forEach(id => state.selected.add(id));
      else if (preset === 'network') Object.keys(SCENARIOS).filter(id => SCENARIOS[id].category === 'network').forEach(id => state.selected.add(id));
      else if (preset === 'week1') {
        Object.entries(SCENARIOS).forEach(([id, s]) => { if (s.startDay <= 7) state.selected.add(id); });
        state.days = 7; document.getElementById('days-slider').value = 7; document.getElementById('days-val').textContent = '7';
      }
      else if (preset === 'week2') {
        Object.entries(SCENARIOS).forEach(([id, s]) => { if (s.startDay >= 7 && s.startDay <= 14) state.selected.add(id); });
        state.days = 14; document.getElementById('days-slider').value = 14; document.getElementById('days-val').textContent = '14';
      }
      // Update checkboxes
      document.querySelectorAll('.scenario-toggle input').forEach(cb => {
        cb.checked = state.selected.has(cb.closest('.scenario-toggle').dataset.id);
      });
      updatePresetHighlight();
      updateAll();
    });
  });

  // Day click on gantt cells, day numbers, heatmap
  document.getElementById('gantt').addEventListener('click', e => {
    const cell = e.target.closest('[data-day]');
    if (!cell) return;
    selectDay(parseInt(cell.dataset.day));
  });
  document.getElementById('heatmap').addEventListener('click', e => {
    const cell = e.target.closest('[data-day]');
    if (!cell) return;
    selectDay(parseInt(cell.dataset.day));
  });

  // Days slider
  document.getElementById('days-slider').addEventListener('input', e => {
    state.days = parseInt(e.target.value);
    document.getElementById('days-val').textContent = state.days;
    updateAll();
  });

  // Scale slider
  document.getElementById('scale-slider').addEventListener('input', e => {
    state.scale = parseFloat(e.target.value) / 10;
    document.getElementById('scale-val').textContent = state.scale.toFixed(1);
    updateAll();
  });

  // Copy button
  document.getElementById('copy-btn').addEventListener('click', () => {
    const text = document.getElementById('prompt').textContent;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-btn');
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Command'; btn.classList.remove('copied'); }, 1500);
    });
  });
}

function selectDay(day) {
  state.selectedDay = state.selectedDay === day ? null : day;
  updateGantt();
  updateDetail();
}

function updatePresetHighlight() {
  const ids = [...state.selected].sort();
  const allIds = Object.keys(SCENARIOS).sort();
  const attackIds = allIds.filter(id => SCENARIOS[id].category === 'attack').sort();
  const opsIds = allIds.filter(id => SCENARIOS[id].category === 'ops').sort();
  const networkIds = allIds.filter(id => SCENARIOS[id].category === 'network').sort();

  document.querySelectorAll('.preset-btn').forEach(btn => {
    const p = btn.dataset.preset;
    let match = false;
    if (p === 'all') match = ids.join(',') === allIds.join(',');
    else if (p === 'attack') match = ids.join(',') === attackIds.join(',');
    else if (p === 'ops') match = ids.join(',') === opsIds.join(',');
    else if (p === 'network') match = ids.join(',') === networkIds.join(',');
    else if (p === 'none') match = ids.length === 0;
    btn.classList.toggle('active', match);
  });
}

// ── Go ─────────────────────────────────────────────────
init();
</script>
</body>
</html>
