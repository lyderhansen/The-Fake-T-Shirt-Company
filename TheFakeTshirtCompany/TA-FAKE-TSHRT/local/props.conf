#
# local/props.conf for TA-FAKE-TSHRT
#
# CIM field enrichment from real Splunk TAs.
# Source: Supporting TA downloads (Splunkbase).
# ONLY adds new EVAL/FIELDALIAS/LOOKUP attributes — never redefines default/ attributes.
#

##############################################################################################################
# WINDOWS - CIM Field Enrichment (Phase 2)
# Source: Splunk_TA_windows v9.x (Splunkbase #742)
# Adds CIM fields for Authentication, Endpoint, Change data models.
# Our events use KV format (not XML), so field names use underscores from KV_MODE=AUTO.
##############################################################################################################

[FAKE:WinEventLog]

# --- CIM Field Aliases (new, not in default/) ---
FIELDALIAS-dest_nt_host = ComputerName AS dest_nt_host
FIELDALIAS-severity_id = EventType AS severity_id
FIELDALIAS-body = Message AS body
FIELDALIAS-event_id = RecordNumber AS event_id
FIELDALIAS-id = RecordNumber AS id
FIELDALIAS-user_id = User_ID AS user_id
FIELDALIAS-service_name = Service_Name AS service, Service_Name AS service_name
FIELDALIAS-parent_process = Creator_Process_Name AS parent_process

# --- CIM EVAL Statements (new, not in default/) ---

# Vendor/product (split fields for CIM)
EVAL-vendor = "Microsoft"
EVAL-product = "Windows"

# Destination: ComputerName is always the dest for WinEventLog
EVAL-dest = ComputerName

# Source: Map based on EventCode (auth events use Source_Network_Address or IpAddress)
EVAL-src = case( \
    EventCode IN (4624,4625), coalesce(Source_Network_Address, IpAddress, Workstation_Name), \
    EventCode==4776, Workstation, \
    EventCode==4778, Client_Address, \
    EventCode IN (4672,4706,4713), ComputerName, \
    true(), src)

# Authentication method (Logon_Type to human-readable)
EVAL-authentication_method = case( \
    EventCode IN (4624,4625), Logon_Type, \
    true(), authentication_method)

# Authentication service (package name)
EVAL-authentication_service = case( \
    EventCode IN (4624,4625), Authentication_Package_Name, \
    true(), authentication_service)

# Process fields for EventCode 4688 (new process creation)
EVAL-process_name = case( \
    EventCode==4688, replace(New_Process_Name, ".*\\\\", ""), \
    true(), process_name)
EVAL-process_path = case( \
    EventCode==4688, New_Process_Name, \
    true(), process_path)
EVAL-process = case( \
    EventCode==4688, coalesce(Process_Command_Line, New_Process_Name), \
    true(), process)

# Parent process for 4688
EVAL-parent_process_name = case( \
    EventCode==4688, replace(Creator_Process_Name, ".*\\\\", ""), \
    true(), parent_process_name)

# Keywords normalization
EVAL-result_id = Keywords


##############################################################################################################
# SYSMON - CIM Field Enrichment (Phase 2)
# Source: Splunk_TA_microsoft_sysmon v4.x (Splunkbase #5765)
# Adds CIM fields for Endpoint (Processes, Filesystem, Registry), Network Traffic, DNS data models.
# Our events use KV format — fields extracted by REPORT transforms in default/props.conf.
##############################################################################################################

[FAKE:WinEventLog:Sysmon]

# --- CIM Field Aliases (new or enhanced from default/) ---
FIELDALIAS-dvc = ComputerName AS dvc
FIELDALIAS-src_port = SourcePort AS src_port
FIELDALIAS-query = QueryName AS query
FIELDALIAS-reply_code_id = QueryStatus AS reply_code_id
FIELDALIAS-registry_path_alias = TargetObject AS registry_path
FIELDALIAS-granted_access = GrantedAccess AS granted_access
FIELDALIAS-process_integrity_level = IntegrityLevel AS process_integrity_level
FIELDALIAS-eventid = EventCode AS EventID

# --- CIM EVAL Statements ---

# Action classification by EventCode
EVAL-action = case( \
    EventCode IN ("1","3","7","8","10"), "allowed", \
    EventCode=="5", "allowed", \
    EventCode=="11", "created", \
    EventCode IN ("13","14"), "modified", \
    EventCode=="22", "allowed", \
    true(), "unknown")

# Destination mapping
EVAL-dest = case( \
    EventCode=="3" AND isnotnull(DestinationHostname) AND DestinationHostname!="-", DestinationHostname, \
    EventCode=="3", DestinationIp, \
    true(), ComputerName)

# Source mapping
EVAL-src = case( \
    EventCode=="3" AND isnotnull(SourceHostname) AND SourceHostname!="-", SourceHostname, \
    EventCode IN ("22") AND isnotnull(ComputerName), ComputerName, \
    true(), SourceIp)

# Process path (CIM: process_path)
EVAL-process_path = case( \
    EventCode IN ("1","3","5","11","13","22"), Image, \
    EventCode=="7", ImageLoaded, \
    true(), Image)

# Process name (extract exe from full path)
EVAL-process_name = case( \
    EventCode IN ("1","3","5","7","11","13","22"), replace(Image, ".*\\\\", ""), \
    true(), replace(Image, ".*\\\\", ""))

# Process ID
EVAL-process_id = ProcessId

# Process GUID
EVAL-process_guid = ProcessGuid

# Process (command line for EID 1, Image for others)
EVAL-process_exec = case( \
    EventCode=="1", CommandLine, \
    true(), Image)

# Parent process fields (EventCode 1 only)
EVAL-parent_process_path = case(EventCode=="1", ParentImage)
EVAL-parent_process_name = case(EventCode=="1", replace(ParentImage, ".*\\\\", ""))
EVAL-parent_process_id = case(EventCode=="1", ParentProcessId)

# File path and file name (EventCode 11 — FileCreate)
EVAL-file_path = case( \
    EventCode=="11", replace(TargetFilename, "(:[\w\\. ]+)", ""), \
    true(), null())
EVAL-file_name = case( \
    EventCode=="11", replace(TargetFilename, ".*\\\\", ""), \
    true(), null())

# Registry fields (EventCode 13 — Registry Value Set)
EVAL-registry_key_name = case( \
    EventCode=="13", replace(TargetObject, ".*\\\\", ""), \
    true(), null())
EVAL-registry_value_name = case( \
    EventCode=="13", replace(TargetObject, ".*\\\\([^)]+|\\(Default\\))$", "\\1"), \
    true(), null())

# Network fields (EventCode 3)
EVAL-app = case(EventCode=="3", Image)
EVAL-direction = case( \
    EventCode=="3" AND Initiated=="true", "outbound", \
    EventCode=="3", "inbound")
EVAL-protocol = case(EventCode=="3", "ip")
EVAL-state = case(EventCode=="3", "established")
EVAL-transport = Protocol

# User extraction (strip domain prefix)
EVAL-user = case( \
    isnotnull(User) AND User!="-", replace(User, ".*\\\\", ""), \
    true(), User)

# Object category for CIM
EVAL-object_category = case( \
    EventCode=="11", "file", \
    EventCode IN ("12","13","14"), "registry", \
    true(), null())

# OS field
EVAL-os = "Microsoft Windows"

# Status field
EVAL-status = case( \
    EventCode=="255", "critical", \
    true(), "success")

# Sysmon EventCode lookup
LOOKUP-eventcode = sysmon_eventcode_lookup EventCode OUTPUTNEW EventDescription, EventDescription AS signature

# DNS record type lookup (EventCode 22)
LOOKUP-record_type = sysmon_record_type_lookup record_type_id OUTPUTNEW record_type_name AS record_type
