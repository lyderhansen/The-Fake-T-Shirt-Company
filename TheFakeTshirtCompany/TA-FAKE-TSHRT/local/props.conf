#
# local/props.conf for TA-FAKE-TSHRT
#
# CIM field enrichment from real Splunk TAs.
# Source: Supporting TA downloads (Splunkbase).
# ONLY adds new EVAL/FIELDALIAS/LOOKUP attributes — never redefines default/ attributes.
#

##############################################################################################################
# WINDOWS - CIM Field Enrichment (Phase 2)
# Source: Splunk_TA_windows v9.x (Splunkbase #742)
# Adds CIM fields for Authentication, Endpoint, Change data models.
# Our events use KV format (not XML), so field names use underscores from KV_MODE=AUTO.
##############################################################################################################

[FAKE:WinEventLog]

# --- CIM Field Aliases (new, not in default/) ---
FIELDALIAS-dest_nt_host = ComputerName AS dest_nt_host
FIELDALIAS-severity_id = EventType AS severity_id
FIELDALIAS-body = Message AS body
FIELDALIAS-event_id = RecordNumber AS event_id
FIELDALIAS-id = RecordNumber AS id
FIELDALIAS-user_id = User_ID AS user_id
FIELDALIAS-service_name = Service_Name AS service, Service_Name AS service_name
FIELDALIAS-parent_process = Creator_Process_Name AS parent_process

# --- CIM EVAL Statements (new, not in default/) ---

# Vendor/product (split fields for CIM)
EVAL-vendor = "Microsoft"
EVAL-product = "Windows"

# Destination: ComputerName is always the dest for WinEventLog
EVAL-dest = ComputerName

# Source: Map based on EventCode (auth events use Source_Network_Address or IpAddress)
EVAL-src = case( \
    EventCode IN (4624,4625), coalesce(Source_Network_Address, IpAddress, Workstation_Name), \
    EventCode==4776, Workstation, \
    EventCode==4778, Client_Address, \
    EventCode IN (4672,4706,4713), ComputerName, \
    true(), src)

# Authentication method (Logon_Type to human-readable)
EVAL-authentication_method = case( \
    EventCode IN (4624,4625), Logon_Type, \
    true(), authentication_method)

# Authentication service (package name)
EVAL-authentication_service = case( \
    EventCode IN (4624,4625), Authentication_Package_Name, \
    true(), authentication_service)

# Process fields for EventCode 4688 (new process creation)
EVAL-process_name = case( \
    EventCode==4688, replace(New_Process_Name, ".*\\\\", ""), \
    true(), process_name)
EVAL-process_path = case( \
    EventCode==4688, New_Process_Name, \
    true(), process_path)
EVAL-process = case( \
    EventCode==4688, coalesce(Process_Command_Line, New_Process_Name), \
    true(), process)

# Parent process for 4688
EVAL-parent_process_name = case( \
    EventCode==4688, replace(Creator_Process_Name, ".*\\\\", ""), \
    true(), parent_process_name)

# Keywords normalization
EVAL-result_id = Keywords


##############################################################################################################
# SYSMON - CIM Field Enrichment (Phase 2)
# Source: Splunk_TA_microsoft_sysmon v4.x (Splunkbase #5765)
# Adds CIM fields for Endpoint (Processes, Filesystem, Registry), Network Traffic, DNS data models.
# Our events use KV format — fields extracted by REPORT transforms in default/props.conf.
##############################################################################################################

[FAKE:WinEventLog:Sysmon]

# --- CIM Field Aliases (new or enhanced from default/) ---
FIELDALIAS-dvc = ComputerName AS dvc
FIELDALIAS-src_port = SourcePort AS src_port
FIELDALIAS-query = QueryName AS query
FIELDALIAS-reply_code_id = QueryStatus AS reply_code_id
FIELDALIAS-registry_path_alias = TargetObject AS registry_path
FIELDALIAS-granted_access = GrantedAccess AS granted_access
FIELDALIAS-process_integrity_level = IntegrityLevel AS process_integrity_level
FIELDALIAS-eventid = EventCode AS EventID

# --- CIM EVAL Statements ---

# Action classification by EventCode
EVAL-action = case( \
    EventCode IN ("1","3","7","8","10"), "allowed", \
    EventCode=="5", "allowed", \
    EventCode=="11", "created", \
    EventCode IN ("13","14"), "modified", \
    EventCode=="22", "allowed", \
    true(), "unknown")

# Destination mapping
EVAL-dest = case( \
    EventCode=="3" AND isnotnull(DestinationHostname) AND DestinationHostname!="-", DestinationHostname, \
    EventCode=="3", DestinationIp, \
    true(), ComputerName)

# Source mapping
EVAL-src = case( \
    EventCode=="3" AND isnotnull(SourceHostname) AND SourceHostname!="-", SourceHostname, \
    EventCode IN ("22") AND isnotnull(ComputerName), ComputerName, \
    true(), SourceIp)

# Process path (CIM: process_path)
EVAL-process_path = case( \
    EventCode IN ("1","3","5","11","13","22"), Image, \
    EventCode=="7", ImageLoaded, \
    true(), Image)

# Process name (extract exe from full path)
EVAL-process_name = case( \
    EventCode IN ("1","3","5","7","11","13","22"), replace(Image, ".*\\\\", ""), \
    true(), replace(Image, ".*\\\\", ""))

# Process ID
EVAL-process_id = ProcessId

# Process GUID
EVAL-process_guid = ProcessGuid

# Process (command line for EID 1, Image for others)
EVAL-process_exec = case( \
    EventCode=="1", CommandLine, \
    true(), Image)

# Parent process fields (EventCode 1 only)
EVAL-parent_process_path = case(EventCode=="1", ParentImage)
EVAL-parent_process_name = case(EventCode=="1", replace(ParentImage, ".*\\\\", ""))
EVAL-parent_process_id = case(EventCode=="1", ParentProcessId)

# File path and file name (EventCode 11 — FileCreate)
EVAL-file_path = case( \
    EventCode=="11", replace(TargetFilename, "(:[\w\\. ]+)", ""), \
    true(), null())
EVAL-file_name = case( \
    EventCode=="11", replace(TargetFilename, ".*\\\\", ""), \
    true(), null())

# Registry fields (EventCode 13 — Registry Value Set)
EVAL-registry_key_name = case( \
    EventCode=="13", replace(TargetObject, ".*\\\\", ""), \
    true(), null())
EVAL-registry_value_name = case( \
    EventCode=="13", replace(TargetObject, ".*\\\\([^)]+|\\(Default\\))$", "\\1"), \
    true(), null())

# Network fields (EventCode 3)
EVAL-app = case(EventCode=="3", Image)
EVAL-direction = case( \
    EventCode=="3" AND Initiated=="true", "outbound", \
    EventCode=="3", "inbound")
EVAL-protocol = case(EventCode=="3", "ip")
EVAL-state = case(EventCode=="3", "established")
EVAL-transport = Protocol

# User extraction (strip domain prefix)
EVAL-user = case( \
    isnotnull(User) AND User!="-", replace(User, ".*\\\\", ""), \
    true(), User)

# Object category for CIM
EVAL-object_category = case( \
    EventCode=="11", "file", \
    EventCode IN ("12","13","14"), "registry", \
    true(), null())

# OS field
EVAL-os = "Microsoft Windows"

# Status field
EVAL-status = case( \
    EventCode=="255", "critical", \
    true(), "success")

# Sysmon EventCode lookup
LOOKUP-eventcode = sysmon_eventcode_lookup EventCode OUTPUTNEW EventDescription, EventDescription AS signature

# DNS record type lookup (EventCode 22)
LOOKUP-record_type = sysmon_record_type_lookup record_type_id OUTPUTNEW record_type_name AS record_type


##############################################################################################################
# AWS CLOUDTRAIL - CIM Field Enrichment (Phase 3)
# Source: Splunk_TA_aws v7.x (Splunkbase #1876)
# Adds CIM fields for Authentication, Change, Cloud data models.
# default/props.conf has: FIELDALIAS user, src, action, dest(=awsRegion), EVAL vendor_product, app
# This stanza adds new FIELDALIAS + EVAL + LOOKUP attributes only.
# EVAL-dest and EVAL-user override the default/ FIELDALIAS (EVAL takes precedence in Splunk).
##############################################################################################################

[FAKE:aws:cloudtrail]

# --- CIM Field Aliases (new, not in default/) ---

# Non-CIM utility aliases
FIELDALIAS-requestParameters_desc = requestParameters AS desc
FIELDALIAS-eventTime_start_time = eventTime AS start_time
FIELDALIAS-temp_access_key = responseElements.credentials.accessKeyId AS temp_access_key
FIELDALIAS-user_access_key = userIdentity.accessKeyId AS user_access_key

# Common CIM
FIELDALIAS-app_type = eventType AS app
FIELDALIAS-dvc = eventSource AS dvc
FIELDALIAS-region = awsRegion AS region
FIELDALIAS-signature = eventName AS signature
FIELDALIAS-src_ip = sourceIPAddress AS src_ip
FIELDALIAS-user_group_id = userIdentity.accountId AS user_group_id
FIELDALIAS-vendor_region = awsRegion AS vendor_region

# Authentication CIM
FIELDALIAS-reason = errorMessage AS reason

# Change CIM
FIELDALIAS-command = eventName AS command
FIELDALIAS-image_id = requestParameters.instancesSet.items{}.imageId AS image_id
FIELDALIAS-instance_type = requestParameters.instanceType AS instance_type
FIELDALIAS-result_id = errorCode AS result_id

# --- CIM EVAL Statements ---

# Error/success message
EVAL-msg = coalesce(errorCode, "success")

# User ARN (full ARN for correlation)
EVAL-user_arn = coalesce('userIdentity.arn', 'requestParameters.roleArn')

# Display name (human-readable user name)
EVAL-userName = coalesce('userIdentity.userName', 'requestParameters.sourceIdentity', \
    'userIdentity.sessionContext.sessionIssuer.userName', \
    if(isnull('userIdentity.arn'), \
        mvindex(split(mvindex(split('requestParameters.roleArn', ":"), -1), "/"), -1), \
        mvindex(split(mvindex(split('userIdentity.arn', ":"), -1), "/"), -1)))

# Result message
EVAL-result = errorMessage

# AWS account ID
EVAL-vendor_account = coalesce('userIdentity.accountId', recipientAccountId)

# CIM user field (overrides FIELDALIAS-user from default/ — EVAL takes precedence)
# Simplified for our 19 eventNames, adapted from real TA's 60+ line CASE
EVAL-user = case( \
    eventName="CreateAccessKey", coalesce('responseElements.accessKey.userName', 'userIdentity.userName'), \
    eventName="DeleteAccessKey", 'userIdentity.userName', \
    eventName="AssumeRole" AND 'userIdentity.type'="AssumedRole", \
        coalesce(mvindex(split('requestParameters.roleArn', "/"), -1), 'userIdentity.sessionContext.sessionIssuer.userName'), \
    eventName="AssumeRole", \
        mvindex(split('responseElements.assumedRoleUser.arn', "/"), -1), \
    eventName="ConsoleLogin" AND 'userIdentity.type'="AssumedRole", \
        coalesce(mvindex(split('userIdentity.principalId', ":"), 1), 'userIdentity.userName'), \
    eventName="ConsoleLogin", \
        coalesce('userIdentity.userName', 'userIdentity.sessionContext.sessionIssuer.userName'), \
    eventName IN ("RunInstances","TerminateInstances","PutObject","GetObject","DeleteObject"), \
        coalesce('userIdentity.userName', 'userIdentity.sessionContext.sessionIssuer.userName'), \
    eventName="GetSecretValue", \
        coalesce(mvindex(split('userIdentity.principalId', ":"), 1), 'userIdentity.sessionContext.sessionIssuer.userName', 'userIdentity.userName'), \
    true(), 'userIdentity.userName')

# CIM user_name
EVAL-user_name = coalesce('userIdentity.userName', \
    'userIdentity.sessionContext.sessionIssuer.userName', \
    if(isnull('userIdentity.arn'), \
        mvindex(split(mvindex(split('requestParameters.roleArn', ":"), -1), "/"), -1), \
        mvindex(split(mvindex(split('userIdentity.arn', ":"), -1), "/"), -1)))

# CIM user_id
EVAL-user_id = case( \
    eventName="ConsoleLogin" AND 'userIdentity.type'="IAMUser", \
        coalesce(mvindex(split('userIdentity.principalId', ":"), 0), 'userIdentity.accountId'), \
    eventName="ConsoleLogin" AND 'userIdentity.type'="AssumedRole", \
        coalesce(mvindex(split('userIdentity.sessionContext.sessionIssuer.principalId', ":"), 0), mvindex(split('userIdentity.principalId', ":"), 0)), \
    eventType="AwsApiCall", \
        mvindex(split('responseElements.assumedRoleUser.assumedRoleId', ":"), 0), \
    true(), 'userIdentity.userName')

# CIM user_type
EVAL-user_type = 'userIdentity.type'

# User agent normalization
EVAL-user_agent = coalesce(userAgent, 'userAgent{}')

# AWS account ID for Authentication CIM
EVAL-aws_account_id = if('userIdentity.type'="AWSAccount" OR 'userIdentity.type'="AWSService", \
    recipientAccountId, 'userIdentity.accountId')

# CIM dest field (overrides FIELDALIAS-dest from default/ — EVAL takes precedence)
# default/ maps dest=awsRegion which is wrong for many events
EVAL-dest = case( \
    eventName="RunInstances", coalesce('responseElements.instancesSet.items{}.instanceId', eventSource), \
    eventName="TerminateInstances", 'requestParameters.instancesSet.items{}.instanceId', \
    eventName IN ("PutObject","GetObject","DeleteObject"), \
        coalesce('requestParameters.host{}', 'requestParameters.Host'), \
    eventName="ConsoleLogin" OR eventName="AssumeRole", \
        coalesce('additionalEventData.LoginTo', eventSource), \
    true(), eventSource)

# CIM object field (resource being acted upon)
EVAL-object = case( \
    eventName IN ("GetObject","PutObject","DeleteObject"), 'requestParameters.bucketName', \
    eventName="DescribeInstances", "Instance", \
    eventName="RunInstances", coalesce('responseElements.instancesSet.items{}.instanceId', eventSource), \
    eventName="TerminateInstances", coalesce('requestParameters.instancesSet.items{}.instanceId', eventSource), \
    eventName="CreateAccessKey", coalesce('responseElements.accessKey.userName', 'userIdentity.userName'), \
    eventName="DeleteAccessKey", 'requestParameters.userName', \
    eventName="GetSecretValue", 'requestParameters.secretId', \
    eventName="Invoke", 'requestParameters.functionName', \
    eventName="AssumeRole", mvindex(split('requestParameters.roleArn', "/"), -1), \
    eventName="ListUsers", "IAM Users", \
    eventName="DescribeAlarms", 'requestParameters.alarmNames{}', \
    eventName="SetAlarmState", 'requestParameters.alarmName', \
    eventName="PutLogEvents", 'requestParameters.logGroupName', \
    true(), eventName)

# CIM object_id (resource identifier)
EVAL-object_id = case( \
    eventName IN ("GetObject","PutObject","DeleteObject"), 'requestParameters.key', \
    eventName="RunInstances", coalesce('responseElements.instancesSet.items{}.instanceId', eventSource), \
    eventName="TerminateInstances", 'requestParameters.instancesSet.items{}.instanceId', \
    eventName="CreateAccessKey", 'responseElements.accessKey.accessKeyId', \
    eventName="DeleteAccessKey", 'requestParameters.accessKeyId', \
    eventName="GetSecretValue", 'resources{}.ARN', \
    eventName="Invoke", 'requestParameters.functionName', \
    eventName="AssumeRole", 'requestParameters.roleArn', \
    true(), null())

# --- Lookups ---

# Action and status from eventName + errorCode (WILDCARD match on errorCode)
LOOKUP-action_status = aws_cloudtrail_action_status_lookup eventName errorCode OUTPUTNEW action status

# Object category from eventName
LOOKUP-object_category = aws_cloudtrail_eventname_lookup eventName OUTPUTNEW object_category

# Change type from eventSource (general)
LOOKUP-changetype_source = aws_cloudtrail_changetype_lookup eventSource OUTPUTNEW change_type

# Change type from eventName (specific, overrides source-based)
LOOKUP-changetype_eventname = aws_cloudtrail_eventname_changetype_lookup eventName OUTPUTNEW change_type
