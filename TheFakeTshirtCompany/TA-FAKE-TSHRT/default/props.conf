##############################################################################################################
#
# props.conf for the FAKE tshirt company
#
# All sourcetypes use :demo suffix to avoid conflicts with production data.
# These stanzas inherit field extractions from installed Splunk Add-ons:
#   - Splunk Add-on for Cisco ASA
#   - Splunk Add-on for Microsoft Cloud Services
#   - Splunk Add-on for AWS
#   - Splunk Add-on for Google Cloud Platform
#
##############################################################################################################


##############################################################################################################
# CLOUD SECURITY
##############################################################################################################

[FAKE:aws:cloudtrail]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "eventTime"\s*:\s*"
TRUNCATE = 999999
# Inherit field extractions from Splunk Add-on for AWS
FIELDALIAS-user_for_cloudtrail = userIdentity.userName AS user
FIELDALIAS-src_for_cloudtrail = sourceIPAddress AS src
FIELDALIAS-action_for_cloudtrail = eventName AS action
FIELDALIAS-dest_for_cloudtrail = awsRegion AS dest
EVAL-vendor_product = "AWS CloudTrail"
EVAL-app = "aws"

[FAKE:aws:cloudwatch:guardduty]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "createdAt"\s*:\s*"
TRUNCATE = 999999
FIELDALIAS-severity_for_guardduty = severity AS severity_id
FIELDALIAS-type_for_guardduty = type AS finding_type
FIELDALIAS-title_for_guardduty = title AS signature
EVAL-vendor_product = "AWS GuardDuty"
EVAL-app = "aws"

[FAKE:aws:billing:cur]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
HEADER_FIELD_LINE_NUMBER = 1
FIELD_DELIMITER = ,
FIELD_QUOTE = "
# Timestamp from lineItem/UsageStartDate (field 8, after "Usage",")
TIME_PREFIX = "Usage","
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
MAX_TIMESTAMP_LOOKAHEAD = 22
EVAL-vendor_product = "AWS Billing"
EVAL-app = "aws"

[FAKE:azure:aad:signin]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "time"\s*:\s*"
TRUNCATE = 999999
# Inherit field extractions from Splunk Add-on for Microsoft Cloud Services
FIELDALIAS-user_for_signin = properties.userPrincipalName AS user
FIELDALIAS-src_for_signin = callerIpAddress AS src
FIELDALIAS-action_for_signin = operationName AS action
EVAL-vendor_product = "Microsoft Entra ID"
# CIM Authentication
EVAL-action = if('properties.status.errorCode'==0,"success","failure")
EVAL-app = lower(replace('properties.appDisplayName', " ", ":"))
EVAL-dest = if('properties.resourceDisplayName' == "null","https://login.microsoftonline.com",lower(replace('properties.resourceDisplayName', " ", ".")))
EVAL-duration = 'properties.processingTimeInMilliseconds'/1000
EVAL-user = lower('properties.userPrincipalName')
EVAL-user_id = lower('properties.userPrincipalName')
LOOKUP-asset_by_src = asset_inventory ip AS src OUTPUT nt_host AS src_nt_host, owner AS src_owner, bunit AS src_bunit, city AS src_city
LOOKUP-identity_by_user = identity_inventory identity AS user OUTPUT first, last, email, managedBy, priority AS user_priority, bunit AS user_bunit, category AS user_category, work_city

[FAKE:azure:aad:audit]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "time"\s*:\s*"
TRUNCATE = 999999
# Inherit field extractions from Splunk Add-on for Microsoft Cloud Services
FIELDALIAS-user_for_audit = identity AS user
FIELDALIAS-src_for_audit = callerIpAddress AS src
FIELDALIAS-action_for_audit = operationName AS action
EVAL-vendor_product = "Microsoft Entra ID"
EVAL-app = "azure:aad"
# CIM Change data model (audit events use properties.operationType, not status.errorCode)
EVAL-action = coalesce('properties.operationType', operationName)
EVAL-result = 'properties.result'

[FAKE:azure:aad:riskDetection]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "time"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 28
TRUNCATE = 999999
FIELDALIAS-user_for_risk = properties.userPrincipalName AS user
FIELDALIAS-src_for_risk = callerIpAddress AS src
EVAL-vendor_product = "Microsoft Entra ID"
EVAL-app = "azure:aad"


##############################################################################################################
# o365 exchange
##############################################################################################################

[FAKE:o365:reporting:messagetrace]
TRANSFORMS-demo_id = extract_demo_id_indexed
KV_MODE = json
MAX_TIMESTAMP_LOOKAHEAD = 20
SHOULD_LINEMERGE = 0
TIME_FORMAT = %Y-%m-%dT%H:%M:%S%Z
TZ = UTC
TIME_PREFIX = \"Received\": \"
REPORT-splunk_ta_o365_cim_all_email_domain = extract_messagetrace_src_user_domain_demo, extract_messagetrace_recipient_domain_demo
FIELDALIAS-o365_reporting_messagetrace_basic_alias_recipient = RecipientAddress AS recipient
FIELDALIAS-o365_reporting_messagetrace_basic_alias_src_user = SenderAddress AS src_user
FIELDALIAS-o365_reporting_messagetrace_basic_alias_dest = ToIP AS dest
FIELDALIAS-o365_reporting_messagetrace_basic_alias_src = FromIP AS src
FIELDALIAS-o365_reporting_messagetrace_basic_alias_message_id = MessageId AS message_id
FIELDALIAS-o365_reporting_messagetrace_basic_alias_subject = Subject AS subject
FIELDALIAS-o365_reporting_messagetrace_basic_alias_size = Size AS size
FIELDALIAS-o365_reporting_messagetrace_basic_alias_internal_message_id = MessageTraceId AS internal_message_id
FIELDALIAS-o365_reporting_messagetrace_basic_alias_status_code = Status AS status_code
EVAL-vendor_product = "Microsoft Office 365 MessageTrace"
EVAL-recipient_count = "1"
LOOKUP-splunk_ta_o365_cim_messagetrace_action = splunk_ta_o365_cim_messagetrace_action Status OUTPUT action
BREAK_ONLY_BEFORE_DATE = 
DATETIME_CONFIG = 
LINE_BREAKER = ([\r\n]+)
pulldown_type = true



##############################################################################################################
# MICROSOFT 365 AUDIT LOG
##############################################################################################################

[FAKE:o365:management:activity]
TRANSFORMS-demo_id = extract_demo_id_indexed
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TRUNCATE = 999999
TIME_PREFIX = "CreationTime"\s*:\s*"
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
MAX_TIMESTAMP_LOOKAHEAD = 28
KV_MODE = json
NO_BINARY_CHECK = true
# CIM field aliases (reference: Splunk Add-on for Microsoft Office 365 v5.x)
FIELDALIAS-user = UserId AS user
FIELDALIAS-src = ClientIP AS src
FIELDALIAS-action = Operation AS action
FIELDALIAS-object = SourceFileName AS object
FIELDALIAS-file_name = SourceFileName AS file_name
FIELDALIAS-file_path = ObjectId AS file_path
FIELDALIAS-app = Workload AS app
EVAL-vendor_product = "Microsoft Office 365"


##############################################################################################################
# NETWORK SECURITY
##############################################################################################################

[FAKE:cisco:asa]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %Y %H:%M:%S.%f
TIME_PREFIX = \<\d+\>
MAX_TIMESTAMP_LOOKAHEAD = 24
KV_MODE = auto
category = Network & Security
description = Cisco ASA Firewall logs for the FAKE tshirt company
pulldown_type = true

REPORT-cisco_asa_field_extractions = cisco_asa_log_level_message_id,cisco_asa_message_id_110003,cisco_asa_message_id_302014_302016,cisco_asa_message_id_302013_302015,cisco_asa_message_id_305011_305012,cisco_asa_message_id_106023,cisco_asa_message_id_609001_609002,cisco_asa_message_id_106015_106016_106017,cisco_asa_message_id_106012,cisco_asa_message_id_106100_106103,cisco_asa_message_id_109025,cisco_asa_message_id_110002,cisco_asa_message_id_111008,cisco_asa_message_id_111010,cisco_asa_message_id_113003,cisco_asa_message_id_113008_113009_113011_113012,cisco_asa_message_id_113019,cisco_asa_message_id_113039,cisco_asa_message_id_302020_302021_inbound,cisco_asa_message_id_302020_302021_outbound,cisco_asa_message_id_304001,cisco_asa_message_id_338301,cisco_asa_message_id_338302,cisco_asa_message_id_400013_400032,cisco_asa_message_id_502103,cisco_asa_message_id_602303_602304_inbound,cisco_asa_message_id_602303_602304_outbound,cisco_asa_message_id_713049,cisco_asa_message_id_713075,cisco_asa_message_id_713119,cisco_asa_message_id_713120,cisco_asa_message_id_713130,cisco_asa_message_id_713172,cisco_asa_message_id_713184,cisco_asa_message_id_713228,cisco_asa_message_id_713905,cisco_asa_message_id_716038,cisco_asa_message_id_716039,cisco_asa_message_id_722051,cisco_asa_message_id_733100,cisco_asa_message_id_805001_805002_805003,cisco_asa_message_id_419002,cisco_asa_message_id_607001_608001,cisco_asa_message_id_716014_716015,cisco_asa_message_id_716016,cisco_asa_message_id_106001,cisco_asa_message_id_305013,cisco_asa_message_id_313001_313004,cisco_asa_message_id_303002,cisco_asa_message_id_710002_710003_710005_710006,cisco_asa_message_id_302010,cisco_asa_message_id_500004,cisco_asa_message_id_106020_106021,cisco_asa_message_id_419003,cisco_asa_message_id_711004,cisco_asa_message_id_507003,cisco_asa_message_id_313009,cisco_asa_message_id_500003,cisco_asa_message_id_106006_106007,cisco_asa_message_id_106014,cisco_asa_message_id_113004_113005,cisco_asa_message_id_314001,cisco_asa_message_id_402119,cisco_asa_message_id_405001,cisco_asa_message_id_602101,cisco_asa_message_id_611101,cisco_asa_message_id_702307,cisco_asa_message_id_713041,cisco_asa_message_id_713121,cisco_asa_message_id_713236,cisco_asa_message_id_713903,cisco_asa_message_id_713906,cisco_asa_message_id_714002_714004_714006,cisco_asa_message_id_714011,cisco_asa_message_id_715001,cisco_asa_message_id_715006_715007,cisco_asa_message_id_715009,cisco_asa_message_id_715038,cisco_asa_message_id_715046,cisco_asa_message_id_715047,cisco_asa_message_id_715048,cisco_asa_message_id_715049,cisco_asa_message_id_715065,cisco_asa_message_id_715076,cisco_asa_message_id_715077,cisco_asa_message_id_715080,cisco_asa_message_id_716001_716002,cisco_asa_message_id_716058_716059,cisco_asa_message_id_716603,cisco_asa_message_id_717009,cisco_asa_message_id_717016,cisco_asa_message_id_717022,cisco_asa_message_id_717024,cisco_asa_message_id_717025,cisco_asa_message_id_717027,cisco_asa_message_id_717028,cisco_asa_message_id_717029,cisco_asa_message_id_717030,cisco_asa_message_id_717036,cisco_asa_message_id_717037,cisco_asa_message_id_717056,cisco_asa_message_id_720041,cisco_asa_message_id_722001_722003,cisco_asa_message_id_722010_722011_722012,cisco_asa_message_id_722022,cisco_asa_message_id_722023,cisco_asa_message_id_722028,cisco_asa_message_id_722029,cisco_asa_message_id_722030,cisco_asa_message_id_722031,cisco_asa_message_id_722032_722033_722034,cisco_asa_message_id_722036,cisco_asa_message_id_722037,cisco_asa_message_id_722041,cisco_asa_message_id_722053_722055,cisco_asa_message_id_725001_725002,cisco_asa_message_id_725003,cisco_asa_message_id_725006_725007,cisco_asa_message_id_725008,cisco_asa_message_id_725010,cisco_asa_message_id_725011,cisco_asa_message_id_725012,cisco_asa_message_id_725014,cisco_asa_message_id_725016,cisco_asa_message_id_725017,cisco_asa_message_id_734001,cisco_asa_message_id_734003,cisco_asa_message_id_737001,cisco_asa_message_id_737003_737006,cisco_asa_message_id_737016,cisco_asa_message_id_737026,cisco_asa_message_id_737034,cisco_asa_message_id_737035,cisco_asa_message_id_746012_746013,cisco_asa_message_id_746014_746015,cisco_asa_message_id_746016,cisco_asa_message_id_713154,cisco_asa_message_id_713160_713162_713163,cisco_asa_message_id_713166,cisco_asa_message_id_713167,cisco_asa_message_id_713185,cisco_asa_message_id_713198,cisco_asa_message_id_713199,cisco_asa_message_id_500001_500002,cisco_asa_message_id_502101_502102,cisco_asa_message_id_502111_502112,cisco_asa_message_id_504001_504002,cisco_asa_message_id_505001_to_505006,cisco_asa_message_id_505007,cisco_asa_message_id_505008,cisco_asa_message_id_505009,cisco_asa_message_id_505010,cisco_asa_message_id_505011,cisco_asa_message_id_505012,cisco_asa_message_id_505013,cisco_asa_message_id_505014,cisco_asa_message_id_505015,cisco_asa_message_id_505016,cisco_asa_message_id_751025,cisco_asa_message_id_751026,cisco_asa_message_id_313005,cisco_asa_message_id_338002,cisco_asa_message_id_109031,cisco_asa_message_id_113021,cisco_asa_message_id_605004_605005,cisco_asa_message_id_716047,cisco_asa_message_id_772002,cisco_asa_message_id_772003_772004,cisco_asa_message_id_609001_609002,cisco_asa_message_id_111001,cisco_asa_message_id_111004,cisco_asa_message_id_111009,cisco_asa_message_id_771002, cisco_asa_message_id_302022_302024_302026, cisco_asa_message_id_302023_302025, cisco_asa_message_id_212011, cisco_asa_message_id_113015, cisco_asa_message_id_430001, cisco_asa_message_id_430007, cisco_asa_message_id_430004, cisco_asa_message_id_430003, cisco_asa_message_id_430002
FIELDALIAS-dvc = host as dvc
EVAL-rule = coalesce(rule, rule_id)
EVAL-acl = coalesce(rule, rule_id)
EVAL-Cisco_ASA_vendor_action = coalesce(lower(vendor_action), lower(action))
EVAL-laction = lower(action)
EVAL-app = case(message_id IN ("716039","113004","716001","113005","113012","113008","713198"), "VPN", message_id IN ("611101", "713166", "713167", "302016", "106012"), "ASA", message_id == "716002", "WebVPN", message_id IN ("110003", "405001") , "Firewall", message_id == "212011", "SNMP" , true(), app)
EVAL-bytes = case(isnotnull(bytes), bytes, isnotnull(bytes_in) AND isnotnull(bytes_out), bytes_in + bytes_out)
EVAL-packets = case(isnotnull(packets), packets, isnotnull(packets_in) AND isnotnull(packets_out), packets_in + packets_out)
EVAL-category = case(message_id IN("400032", "106017"), "DOS", message_id IN("106016"), "Spoofing", message_id IN ("430001"), "Attempted Information Leak", true(), category)
EVAL-direction = case(direction == "egress", "outbound", true(), lower(direction))
EVAL-duration = ((coalesce(duration_day, 0))*24*60*60) + (duration_hour*60*60) + (duration_minute*60) + (duration_second)
EVAL-dest = if(message_id IN ("771002","111009","111004","111001","113021","109031","716047","772002","772003","772004","502101","502102","716058","716059","717029","611101","716039","716038","113008","113012","713185","713167","713166","111010","502103","502111","502112","505015","505004","505009","713198","716001","716002","722030","722031","722032","722033","722034","313001","113015"), host, coalesce(dest, dest_ip, dest_host, assigned_ipv4))
EVAL-dest_ip = if(message_id IN ("502101", "502102","716058","716059","611101","716039","716038","113008","113012","713185","713167","713166","111010","502103","502111","502112","505015","505004","505009","713198","716001","716002","722030","722031","722032","722033","722034","313001"), if(match(host,"(?:\d+\.\d+\.\d+\.\d+)|(?:^(?:[0-9A-Fa-f]{0,4}:){2,7}(?:[0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$)"), host, null), coalesce(dest_ip,assigned_ipv4))
EVAL-dest_host = if(message_id IN ("502101", "502102","716058","716059","611101","716039","716038","113008","113012","713185","713167","713166","111010","502103","502111","502112","505015","505004","505009","713198","716001","716002","722030","722031","722032","722033","722034","313001"), if(not match(host,"(?:\d+\.\d+\.\d+\.\d+)|(?:^(?:[0-9A-Fa-f]{0,4}:){2,7}(?:[0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$)"), host, null), dest_host)
EVAL-ids_type = "network"
EVAL-object = case(message_id IN("111004"), src, message_id IN("111009"), command, message_id IN("713228"), user, message_id IN ("502101","502102","502103"), "user account", message_id == "111010", process_name, true(), coalesce(object, object_id))
EVAL-object_attrs = case(message_id IN ("502101","502102"), mvappend("username","user privilege","encrypted password"), message_id == "502103", "user privilege", message_id == "505009", "version",  true(), lower(object_attrs))
EVAL-object_id = case(message_id == "713228", user, message_id IN ("502101", "502102"), "user account", true(), coalesce(object_id, object))
EVAL-object_category = case(message_id == "111010", "filesystem" , message_id == "111009", "command" , message_id == "771002", "configuration" , true(), lower(object_category))
EVAL-communication_protocol = if(match(coalesce(src_ip,dest_ip,src,dest),":"), "ipv6", if(match(coalesce(src_ip,dest_ip,src,dest), "(?:\d+\.\d+\.\d+\.\d+)"),"ipv4", null))
EVAL-user = if(message_id IN ("113015"), src_user, if(lower(direction) == "inbound" AND message_id IN ("302020", "302021"), src_user, if(lower(direction) == "outbound" AND message_id IN ("302020", "302021", "106023"), dest_user, user)))
EVAL-src_ip = if(message_id IN ("609001","609002"), if(match(host,"(?:\d+\.\d+\.\d+\.\d+)|(?:^(?:[0-9A-Fa-f]{0,4}:){2,7}(?:[0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$)"),host,null), coalesce(src_ip,assigned_ipv4))
EVAL-src = if(message_id IN ("212011"), host, coalesce(src, src_ip, src_host))
EVAL-ssl_is_valid = case(ssl_is_valid == "failed", "false", ssl_is_valid == "validated", "true", true(), ssl_is_valid)
EVAL-status = case(message_id IN ("502101","502102","502111", "502112", "504001", "504002", "505004","505006","505009", "505015","500001","500002","111010","502103","111001","111004","111009","771002"), "success", true(), status)
EVAL-protocol = case(message_id == "338301" OR (lower(transport) IN ("tcp","udp")), "ip", lower(transport)=="icmp", "icmp", true(), protocol)
EVAL-transport = lower(transport)
EVAL-vendor_action = case(message_id IN ("313005","338002"), "blocked", message_id IN ("419003","419002","400013","500003"), "flow", true(), coalesce(lower(vendor_action), lower(action)))
EVAL-severity = case(message_id IN ("106016", "106017", "400032", "110003"), "informational", message_id == "405001", "low", message_id IN ("212011"), "high")
EVAL-type = case(message_id == "110003" , "unknown", message_id == "405001" , "event", message_id == "212011" , "alert" , true(), type)
EVAL-command = if(message_id=="111010", parent_process_name, command)
EVAL-signature = case(message_id IN ("725007"), "SSL session with "+peer_type, message_id IN ("722033","722034"), "SVC", message_id IN ("751025","751026"), "AnyConnect", message_id IN ("106016"), "Spoof Attack", message_id IN ("106017"), "Land Attack", message_id IN ("722051","713228"), "IP assigned", message_id IN ("110003"), "Routing failed to locate next hop", message_id IN ("609001","609002"), action+" local-host", message_id IN ("113015"), "Authentication Rejected", true(), signature)
EVAL-signature_id = if(message_id IN ("405001","110003","106023","725003"), message_id, signature_id)
EVAL-result = if(message_id IN ("111009"), command, result)
EVAL-dest_public_port = if(lower(transport) == "icmp" AND isnotnull(dest_public_port), 0, dest_public_port)
EVAL-dest_port = if(lower(transport) == "icmp" AND isnotnull(dest_port), 0, coalesce(dest_port, service))
EVAL-src_public_port = if(lower(transport) == "icmp" AND isnotnull(src_public_port), 0, src_public_port)
EVAL-src_translated_port = if(lower(transport) == "icmp" AND isnotnull(src_translated_port), 0, src_translated_port)
EVAL-dest_translated_port = if(lower(transport) == "icmp" AND isnotnull(dest_translated_port), 0, dest_translated_port)
EVAL-src_port = if(lower(transport) == "icmp" AND isnotnull(src_port), 0, src_port)
LOOKUP-cisco_asa_action_lookup_1 = cisco_asa_action_lookup vendor_action AS laction OUTPUT action, action AS Cisco_ASA_action
LOOKUP-cisco_asa_action_lookup_2 = cisco_asa_action_lookup message_id OUTPUTNEW action, action AS Cisco_ASA_action
LOOKUP-cisco_asa_change_analysis_lookup = cisco_asa_change_analysis_lookup message_id
LOOKUP-cisco_asa_severity_lookup = cisco_asa_severity_lookup signature_id
LOOKUP-cisco_asa_syslog_severity_lookup = cisco_asa_syslog_severity_lookup log_level
LOOKUP-cisco_asa_vendor_class_lookup = cisco_asa_vendor_class_lookup message_id
LOOKUP-cisco_asa_protocol_version = cisco_asa_protocol_version protocol,communication_protocol OUTPUTNEW protocol_version
LOOKUP-asset_by_src = asset_inventory ip AS src OUTPUT nt_host AS src_nt_host, dns AS src_dns, owner AS src_owner, priority AS src_priority, bunit AS src_bunit, city AS src_city
LOOKUP-asset_by_dest = asset_inventory ip AS dest OUTPUT nt_host AS dest_nt_host, dns AS dest_dns, owner AS dest_owner, priority AS dest_priority, bunit AS dest_bunit, city AS dest_city
FIELDALIAS-Cisco_ASA_message_id = message_id AS Cisco_ASA_message_id
FIELDALIAS-Cisco_ASA_user = user AS Cisco_ASA_user, user AS Username
FIELDALIAS-dest_zone = dest_interface AS dest_zone
FIELDALIAS-group = Group AS group
FIELDALIAS-IP = ip_address AS IP
FIELDALIAS-rule_name = rule AS rule_name
FIELDALIAS-src_zone = src_interface AS src_zone
EVAL-assigned_ip = coalesce(assigned_ipv4, assigned_ipv6)
EVAL-vendor = "Cisco"
EVAL-product = "ASA"
EVAL-vendor_product = "Cisco ASA"

#set host field
TRANSFORMS-set_host = set_host_from_asa_syslog_fake


##############################################################################################################
# WINDOWS - Event Logs
##############################################################################################################

[FAKE:WinEventLog]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)(?=\d{2}/\d{2}/\d{4}\s+\d{1,2}:\d{2}:\d{2}\s+(?:AM|PM))
TIME_FORMAT = %m/%d/%Y %I:%M:%S %p
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 25
KV_MODE = AUTO
TRUNCATE = 99999

# Host extraction from demo_host field
TRANSFORMS-set_host = set_host_from_wineventlog
TRANSFORMS-set_source = set_source_from_logname


# Field aliases
FIELDALIAS-dvc = host AS dvc
FIELDALIAS-event_id = EventCode AS signature_id
FIELDALIAS-category = TaskCategory AS category

# Calculated fields
EVAL-vendor_product = "Microsoft Windows"
EVAL-app = "windows"

# Lookups
LOOKUP-severity = windows_severity_lookup Type OUTPUTNEW severity
LOOKUP-signature = windows_signature_lookup signature_id OUTPUTNEW signature, action, result
LOOKUP-identity_by_user = identity_inventory identity AS user OUTPUT first, last, email, managedBy, priority AS user_priority, bunit AS user_bunit, category AS user_category, work_city


##############################################################################################################
# WINDOWS - Perfmon
##############################################################################################################

[FAKE:Perfmon:Generic]
TRANSFORMS-demo_id = extract_demo_id_indexed
LINE_BREAKER = ([\r\n])\d\d\/
MAX_TIMESTAMP_LOOKAHEAD = 19
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
TRUNCATE = 99999
KV_MODE = auto
TRANSFORMS-host_from_log = host_from_demo_field
TRANSFORMS-route_sourcetype = FAKE_st_perfmon_network_interface, FAKE_st_perfmon_generic_object, FAKE_st_perfmon_sqlserver_sql_statistics, FAKE_st_perfmon_sqlserver_buffer_manager, FAKE_st_perfmon_sqlserver_locks



[FAKE:Perfmon:Processor]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo
REPORT-perfmon_fields = extract_perfmon_processor_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "cpu"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:Memory]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo
REPORT-perfmon_fields = extract_perfmon_memory_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "memory"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:LogicalDisk]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo
REPORT-perfmon_fields = extract_perfmon_disk_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "disk"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:Network_Interface]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo
REPORT-perfmon_fields = extract_perfmon_network_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "network"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:SQLServer:sql_statistics]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo_field
REPORT-perfmon_fields = extract_perfmon_sqlserver_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "sqlserver"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:SQLServer:buffer_manager]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo_field
REPORT-perfmon_fields = extract_perfmon_sqlserver_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "sqlserver"
EVAL-vendor_product = "Microsoft Windows"

[FAKE:Perfmon:SQLServer:locks]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n])\d\d\/
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 99999
KV_MODE = auto

TRANSFORMS-host_from_log = host_from_demo_field
REPORT-perfmon_fields = extract_perfmon_sqlserver_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "sqlserver"
EVAL-vendor_product = "Microsoft Windows"


##############################################################################################################
# LINUX - System Metrics
# Log format: YYYY-MM-DD HH:MM:SS hostname metric_data
##############################################################################################################

[FAKE:cpu]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 10000
KV_MODE = auto

TRANSFORMS-set_host = set_host_from_linux_fake
REPORT-cpu_fields = extract_linux_cpu_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "cpu"
EVAL-cpu_load_percent = 100 - pctIdle
EVAL-vendor_product = "Linux"

[FAKE:vmstat]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 10000
KV_MODE = auto

TRANSFORMS-set_host = set_host_from_linux_fake
REPORT-vmstat_fields = extract_linux_vmstat_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "memory"
EVAL-vendor_product = "Linux"

[FAKE:df]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 10000
KV_MODE = auto

TRANSFORMS-set_host = set_host_from_linux_fake
REPORT-df_fields = extract_linux_df_fields

FIELDALIAS-dest = host AS dest
FIELDALIAS-mount = MountedOn AS mount
FIELDALIAS-filesystem = Filesystem AS filesystem
EVAL-metric_name = "disk"
EVAL-storage_used_percent = tonumber(rtrim(UsePct, "%"))
EVAL-vendor_product = "Linux"

[FAKE:iostat]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 10000
KV_MODE = auto

TRANSFORMS-set_host = set_host_from_linux_fake
REPORT-iostat_fields = extract_linux_iostat_fields

FIELDALIAS-dest = host AS dest
EVAL-metric_name = "disk_io"
EVAL-vendor_product = "Linux"

[FAKE:interfaces]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 19
TRUNCATE = 10000
KV_MODE = auto

TRANSFORMS-set_host = set_host_from_linux_fake
REPORT-interfaces_fields = extract_linux_interfaces_fields

FIELDALIAS-dest = host AS dest
FIELDALIAS-interface = Iface AS interface
EVAL-metric_name = "network"
EVAL-vendor_product = "Linux"


##############################################################################################################
# LINUX - Auth Log (SSH, sudo, cron, systemd)
##############################################################################################################

[FAKE:linux:auth]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %e %H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 15
TRUNCATE = 10000

# Host extraction from auth.log format: "Jan  5 14:23:45 <hostname> ..."
TRANSFORMS-set_host = set_host_from_auth_log
EXTRACT-auth_process = ^[A-Z][a-z]{2}\s+\d+\s[\d:]+\s\S+\s(?<process>\w[\w\-]*)\[(?<pid>\d+)\]
EXTRACT-auth_user = (?:for|user)\s+(?:invalid user )?(?<user>\S+)
EXTRACT-auth_src = from\s+(?<src>\S+)\s+port\s+(?<src_port>\d+)
EXTRACT-auth_action = ^[A-Z][a-z]{2}\s+\d+\s[\d:]+\s\S+\s\S+\s(?<action>Accepted|Failed|session opened|session closed|CMD)\b
EVAL-vendor_product = "Linux"
LOOKUP-identity_by_user = identity_inventory identity AS user OUTPUT first, last, email, managedBy, priority AS user_priority, bunit AS user_bunit, work_city


##############################################################################################################
# WEB
##############################################################################################################

[FAKE:access_combined]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %d/%b/%Y:%H:%M:%S %z
TIME_PREFIX = \[
MAX_TIMESTAMP_LOOKAHEAD = 26
KV_MODE = auto

REPORT-access = extract_access_combined_fields

FIELDALIAS-src = clientip AS src
FIELDALIAS-dest = host AS dest
FIELDALIAS-http_method = method AS http_method
FIELDALIAS-url = uri AS url
FIELDALIAS-http_status = status AS http_status
EVAL-vendor_product = "Apache"
EVAL-app = "apache"
category = Custom




##############################################################################################################
# Order and Servicebus
##############################################################################################################

[FAKE:azure:servicebus]
TRANSFORMS-demo_id = extract_demo_id_indexed
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = \"enqueuedTimeUtc\": \"
MAX_TIMESTAMP_LOOKAHEAD = 28
TRUNCATE = 999999
EVAL-vendor_product = "Microsoft Azure Service Bus"

[FAKE:online:order:registry]
TRANSFORMS-demo_id = extract_demo_id_indexed
LINE_BREAKER = ([\r\n]+)
SHOULD_LINEMERGE = false
MAX_TIMESTAMP_LOOKAHEAD = 24
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = \"timestamp\": \"
KV_MODE = json
TRUNCATE = 99999
EVAL-vendor_product = "Retail Order System"


[FAKE:online:order]
TRANSFORMS-demo_id = extract_demo_id_indexed
LINE_BREAKER = ([\r\n]+)
SHOULD_LINEMERGE = false
MAX_TIMESTAMP_LOOKAHEAD = 24
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = \"timestamp\": \"
KV_MODE = json
TRUNCATE = 99999
EVAL-vendor_product = "Retail Order System"


# =============================================================================
# GCP DEMO PROPS - Splunk Log Generator Demo App
# Full CIM-compatible field extractions copied from Splunk_TA_google-cloudplatform
# =============================================================================

# -----------------------------------------------------------------------------
# BASE SOURCETYPE - Routes to specific sourcetypes based on logName
# -----------------------------------------------------------------------------
[FAKE:google:gcp:pubsub:audit]
TRANSFORMS-demo_id = extract_demo_id_indexed
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)\{
TRUNCATE = 999999
TIME_PREFIX = \"timestamp\"\s*:\s*\"
MAX_TIMESTAMP_LOOKAHEAD = 30
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ

TRANSFORMS-set_host = set_host_from_gcp_project
TRANSFORMS-sourcetype_activity = gcp_pubsub_activity_sourcetype_demo
TRANSFORMS-sourcetype_data_access = gcp_pubsub_data_access_sourcetype_demo

# -----------------------------------------------------------------------------
# ADMIN ACTIVITY SOURCETYPE - Change CIM
# -----------------------------------------------------------------------------
[FAKE:google:gcp:pubsub:audit:admin_activity]
TRANSFORMS-demo_id = extract_demo_id_indexed
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)\{
TRUNCATE = 999999
TIME_PREFIX = \"timestamp\"\s*:\s*\"
MAX_TIMESTAMP_LOOKAHEAD = 30
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ

TRANSFORMS-set_host = set_host_from_gcp_project


## Extraction ##
REPORT-splunk_ta_gcp_audit_cim_change_updated_user = gcp_change_updated_user1_demo, gcp_change_updated_user2_demo
REPORT-splunk_ta_gcp_audit_cim_change_updated_value = gcp_change_updated_value1_demo, gcp_change_updated_value2_demo

## Aliases ##
FIELDALIAS-splunk_ta_gcp_audit_cim_change_dest_user = updated_user as dest_user

## Eval ##
EVAL-command = coalesce('protoPayload.methodName','data.protoPayload.methodName')

EVAL-dvc = case('protoPayload.methodName'="SetIamPolicy", "iam.googleapis.com", \
              'data.protoPayload.methodName'="SetIamPolicy", "iam.googleapis.com", \
              true(), coalesce('protoPayload.serviceName', 'data.protoPayload.serviceName'))

EVAL-dest = case( \
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.request.resource', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.request.resource', \
    'protoPayload.methodName' in ("google.admin.AdminService.changeUserAddress", "google.iam.admin.v1.CreateServiceAccount"), mvindex(split('protoPayload.resourceName', "/"), 1), \
    'data.protoPayload.methodName' in ("google.admin.AdminService.changeUserAddress", "google.iam.admin.v1.CreateServiceAccount"), mvindex(split('data.protoPayload.resourceName', "/"), 1), \
    match('protoPayload.methodName', "^google\.iam\.admin\.v\d+\.(CreateServiceAccountKey|DeleteServiceAccount|PatchServiceAccount|DisableServiceAccount|SetIAMPolicy)$"), 'resource.labels.project_id', \
    match('data.protoPayload.methodName', "^google\.iam\.admin\.v\d+\.(CreateServiceAccountKey|DeleteServiceAccount|PatchServiceAccount|DisableServiceAccount|SetIAMPolicy)$"), 'data.resource.labels.project_id', \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(insert)"), if(severity="ERROR", mvindex(split('protoPayload.resourceName',"/"), -1), 'resource.labels.project_id'), \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(insert)"), if('data.severity'="ERROR", mvindex(split('data.protoPayload.resourceName',"/"), -1), 'data.resource.labels.project_id'), \
    match('protoPayload.methodName', "(v\d+)\.compute\.instances\.(start|reset|delete|attachDisk|detachDisk)"), mvindex(split('protoPayload.resourceName',"/"), -1), \
    match('data.protoPayload.methodName', "(v\d+)\.compute\.instances\.(start|reset|delete|attachDisk|detachDisk)"), mvindex(split('data.protoPayload.resourceName',"/"), -1), \
    true(), coalesce('resource.labels.project_id', 'data.resource.labels.project_id', mvindex(split('protoPayload.resourceName', "/"), 1), mvindex(split('data.protoPayload.resourceName', "/"), 1)) \
)

EVAL-object = case( \
    'protoPayload.methodName'="google.login.LoginService.logout", 'protoPayload.authenticationInfo.principalEmail',\
    'data.protoPayload.methodName'="google.login.LoginService.logout", 'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="storage.objects.update", 'resource.labels.bucket_name',\
    'data.protoPayload.methodName'="storage.objects.update", 'data.resource.labels.bucket_name',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('protoPayload.methodName',"google.admin.AdminService.%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService.%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    like('protoPayload.methodName',"google.iam.admin.v%") AND isnotnull('resource.labels.email_id'),'resource.labels.email_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v%") AND isnotnull('data.resource.labels.email_id'), 'data.resource.labels.email_id',\
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), -1),\
    isnotnull('data.protoPayload.resourceName'), mvindex(split('data.protoPayload.resourceName', "/"), -1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), -1) \
)

EVAL-object_id = case( \
    like('protoPayload.methodName',"google.iam.admin.%.CreateServiceAccount"), if(isnotnull('protoPayload.request.service_account.description'), 'resource.labels.unique_id', 'protoPayload.resourceName'),\
    like('data.protoPayload.methodName',"google.iam.admin.%.CreateServiceAccount"), if(isnotnull('data.protoPayload.request.service_account.description'), 'data.resource.labels.unique_id', 'data.protoPayload.resourceName'),\
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount|PatchServiceAccount)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount|PatchServiceAccount)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateServiceAccountKey)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateServiceAccountKey)"), 'data.protoPayload.resourceName',\
    like('protoPayload.methodName',"google.pubsub.%.Subscriber.DeleteSubscription"), 'protoPayload.resourceName',\
    like('data.protoPayload.methodName',"google.pubsub.%.Subscriber.DeleteSubscription"), 'data.protoPayload.resourceName',\
    like('protoPayload.methodName',"google.pubsub.%.Publisher.CreateTopic"), 'protoPayload.resourceName', \
    like('data.protoPayload.methodName',"google.pubsub.%.Publisher.CreateTopic"), 'data.protoPayload.resourceName', \
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(UndeleteRole|CreateRole|DeleteRole|UpdateRole)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(UndeleteRole|CreateRole|DeleteRole|UpdateRole)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"storage\.buckets\.(create|delete|update)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"storage\.buckets\.(create|delete|update)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"storage\.objects\.(update)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"storage\.objects\.(update)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), if(severity IN ("ERROR"), 'protoPayload.resourceName', 'resource.labels.instance_id'), \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), if('data.severity' IN ("ERROR"), 'data.protoPayload.resourceName', 'data.resource.labels.instance_id'), \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'resource.labels.disk_id', \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'data.resource.labels.disk_id', \
    'protoPayload.methodName'="Subscriber.InternalExpireInactiveSubscription", 'protoPayload.resourceName',\
    'data.protoPayload.methodName'="Subscriber.InternalExpireInactiveSubscription", 'data.protoPayload.resourceName',\
    'protoPayload.methodName'="storage.setIamPermissions", 'protoPayload.resourceName',\
    'data.protoPayload.methodName'="storage.setIamPermissions", 'data.protoPayload.resourceName',\
    'protoPayload.methodName'="SetIamPolicy", coalesce('resource.labels.unique_id', 'protoPayload.resourceName'),\
    'data.protoPayload.methodName'="SetIamPolicy", coalesce('data.resource.labels.unique_id', 'data.protoPayload.resourceName'),\
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    like('protoPayload.methodName',"google.admin.AdminService.%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService.%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    isnotnull('data.resource.labels.disk_id'),'data.resource.labels.disk_id',\
    like('protoPayload.methodName',"google.iam.admin.v1%") AND isnotnull('resource.labels.unique_id'),'resource.labels.unique_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v1%") AND isnotnull('data.resource.labels.unique_id'), 'data.resource.labels.unique_id',\
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), -1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), -1) \
)

EVAL-object_path = case( \
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount)"), mvjoin(mvindex(split('protoPayload.request.name', "/"), 0, 2), "/")+"/" , \
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount)"), mvjoin(mvindex(split('data.protoPayload.request.name', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), mvjoin(mvindex(split('protoPayload.request.resource', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), mvjoin(mvindex(split('data.protoPayload.request.resource', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.admin\.AdminService\.(changePassword|removeRecoveryPhone)"), 'protoPayload.resourceName', \
    match('data.protoPayload.methodName',"google\.admin\.AdminService\.(changePassword|removeRecoveryPhone)"), 'data.protoPayload.resourceName', \
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"Subscriber\.InternalExpireInactiveSubscription"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"Subscriber\.InternalExpireInactiveSubscription"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "storage\.buckets\.(create|delete|update)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.buckets\.(create|delete|update)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "storage\.objects\.(update)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.objects\.(update)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "storage\.(setIamPermissions)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.(setIamPermissions)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 3), "/")+"/" , \
    match('data.protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 3), "/")+"/" , \
    like('protoPayload.methodName',"google.iam.admin.%"), mvjoin(mvindex(split('protoPayload.response.name', "/"), 0, 2), "/")+"/" , \
    like('data.protoPayload.methodName',"google.iam.admin.%"), mvjoin(mvindex(split('data.protoPayload.response.name', "/"), 0, 2), "/")+"/" \
)

EVAL-result = case( \
    'severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), 'protoPayload.methodName', \
    'severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), coalesce('protoPayload.response.error.errors{}.reason', 'protoPayload.response.error.message', 'protoPayload.status.message'), \
    'data.severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), 'data.protoPayload.methodName', \
    'data.severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), coalesce('data.protoPayload.response.error.errors{}.reason', 'data.protoPayload.response.error.message', 'data.protoPayload.status.message') \
)

EVAL-result_id = coalesce( \
    'protoPayload.response.error.code',\
    'data.protoPayload.response.error.code',\
    'protoPayload.status.code',\
    'data.protoPayload.status.code' \
)

EVAL-src = coalesce('protoPayload.requestMetadata.callerIp','data.protoPayload.requestMetadata.callerIp')
EVAL-src_ip = coalesce('protoPayload.requestMetadata.callerIp','data.protoPayload.requestMetadata.callerIp')
EVAL-user_agent = coalesce('protoPayload.requestMetadata.callerSuppliedUserAgent','data.protoPayload.requestMetadata.callerSuppliedUserAgent')

EVAL-user_id = case( \
    match('resource.type',"service_account"),'resource.labels.unique_id',\
    match('data.resource.type',"service_account"),'data.resource.labels.unique_id',\
    isnotnull('protoPayload.authenticationInfo.principalEmail'),'protoPayload.authenticationInfo.principalEmail',\
    isnotnull('data.protoPayload.authenticationInfo.principalEmail'),'data.protoPayload.authenticationInfo.principalEmail' \
)

EVAL-user_type = case( \
    coalesce('protoPayload.methodName', 'data.protoPayload.methodName')="SetIamPolicy", "service_account", \
    match('resource.type',"pubsub_subscription"),"service_account",match('data.resource.type',"pubsub_subscription"),"service_account",\
    match('resource.type',"service_account"),"service_account",match('data.resource.type',"service_account"),"service_account" \
)

EVAL-action = case( \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.buckets.setIamPolicy","modified",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.setIamPermissions","modified",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="beta.compute.firewalls.insert","modified",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "setiampermissions") AND match('resource.type',"service_account"), "modified", \
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "setiampermissions"),"acl_modified",\
    like(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "%.createserviceaccountkey"),"modified",\
    like(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "%.disableserviceaccount"),"modified",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(create|insert|undelete)"),"created",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="Subscriber.InternalExpireInactiveSubscription","deleted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "delete"),"deleted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "reset"),"restarted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(start|enable)"),"started",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(stop|disable)"),"stopped",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(update|patch|attachdisk|detachdisk|set|change|remove|add)"), "modified",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "list"),"logs_read",\
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'), "google.login.LoginService.logout"),"logoff",\
    true(), "unknown" \
)

EVAL-change_type = case( \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Publisher\.CreateTopic"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"Subscriber\.InternalExpireInactiveSubscription"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "Virtual Server", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "Virtual Server", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "firewall", \
    like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage.%"), "storage", \
    true(), "AAA" \
)

EVAL-object_attrs = case( \
    coalesce('protoPayload.methodName', 'data.protoPayload.methodName')="SetIamPolicy", "policy", \
    like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google.iam.admin.%.CreateServiceAccountKey"), "ServiceAccountKey", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.changePassword", "password", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.removeRecoveryPhone", "RECOVERY_PHONE", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.addRecoveryEmail", "RECOVERY_EMAIL", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.changeUserAddress", "USER_ADDRESS", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="login.googleapis.com", "login session",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.login.LoginService.logout", "login session",\
    true(), coalesce('resource.type', 'data.resource.type', "project") \
)

EVAL-object_category = case( \
    'protoPayload.methodName' in ("google.pubsub.v1.Publisher.CreateTopic", "Subscriber.InternalExpireInactiveSubscription"), 'resource.type', \
    'data.protoPayload.methodName' in ("google.pubsub.v1.Publisher.CreateTopic", "Subscriber.InternalExpireInactiveSubscription"), 'data.resource.type', \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.setIamPermissions", "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage\.objects\.(update)"), "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage\.buckets\.(create|delete|update)"), "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.iam\.admin\.v\d+\.(UndeleteRole|DeleteRole|CreateRole|UpdateRole)"), "role", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "firewall", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "disk", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "instance", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), "pubsub_subscription", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.iam\.admin\.v\d+\.CreateServiceAccountKey"), "user", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="SetIamPolicy", "user", \
    coalesce('resource.type', 'data.resource.type')="service_account", "user",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.login.LoginService.logout", "user",\
    coalesce('protoPayload.metadata.event{}.eventType', 'data.protoPayload.metadata.event{}.eventType')="USER_SETTINGS","user" \
)

EVAL-resource_type = case(match('protoPayload.metadata.event{}.eventType',"USER_SETTINGS"),"iam_user", \
                        match('data.protoPayload.metadata.event{}.eventType',"USER_SETTINGS"),"iam_user", \
                        true(), coalesce('resource.type', 'data.resource.type'))

EVAL-src_user = case( \
    ('protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'protoPayload.authenticationInfo.principalEmail',\
    ('data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'data.protoPayload.authenticationInfo.principalEmail', \
    match('resource.type',"service_account"),'protoPayload.authenticationInfo.principalEmail',\
    match('data.resource.type',"service_account"),'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.authenticationInfo.principalEmail', \
    true(), "No src_user" )

EVAL-src_user_name = case( \
    ('protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'protoPayload.authenticationInfo.principalEmail',\
    ('data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'data.protoPayload.authenticationInfo.principalEmail', \
    match('resource.type',"service_account"),'protoPayload.authenticationInfo.principalEmail',\
    match('data.resource.type',"service_account"),'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.authenticationInfo.principalEmail', \
    true(), "No src_user_name" \
)

EVAL-status = case( \
    coalesce('data.severity', 'severity') IN ("DEBUG","INFO","NOTICE","WARNING"), "success",\
    coalesce('data.severity', 'severity') IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), "failure" \
)

EVAL-user = case( \
    'protoPayload.metadata.event{}.eventType'="USER_SETTINGS", updated_user,\
    'data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS", updated_user,\
    'protoPayload.methodName'="storage.setIamPermissions",'protoPayload.authenticationInfo.principalEmail',\
    'data.protoPayload.methodName'="storage.setIamPermissions",'data.protoPayload.authenticationInfo.principalEmail',\
    match(lower('protoPayload.methodName'), "(createserviceaccount|deleteserviceaccount|patchserviceaccount|disableserviceaccount)"), 'resource.labels.email_id',\
    match(lower('data.protoPayload.methodName'), "(createserviceaccount|deleteserviceaccount|patchserviceaccount|disableserviceaccount)"), 'data.resource.labels.email_id',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    isnotnull('protoPayload.authenticationInfo.principalEmail'),'protoPayload.authenticationInfo.principalEmail',\
    isnotnull('data.protoPayload.authenticationInfo.principalEmail'),'data.protoPayload.authenticationInfo.principalEmail',\
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('protoPayload.methodName',"google.admin.AdminService%"),'protoPayload.metadata.event{}.parameter{}.value',\
    like('data.protoPayload.methodName',"google.admin.AdminService%"),'data.protoPayload.metadata.event{}.parameter{}.value',\
    like('protoPayload.methodName',"google.iam.admin.v%"),'resource.labels.email_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v%"),'data.resource.labels.email_id',\
    true(), 'data.resource.labels.email_id' \
)

EVAL-user_name = case( \
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateRole|UndeleteRole|DeleteRole|UpdateRole)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateRole|UndeleteRole|DeleteRole|UpdateRole)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.(DisableServiceAccount)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DisableServiceAccount)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"storage\.buckets\.(create|delete|update|setIamPolicy)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"storage\.buckets\.(create|delete|update|setIamPolicy)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"storage\.objects\.(update)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"storage\.objects\.(update)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "storage\.(setIamPermissions)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "storage\.(setIamPermissions)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('protoPayload.methodName',"google.admin.AdminService%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    true(), coalesce('protoPayload.response.display_name','data.protoPayload.response.display_name', 'protoPayload.response.displayName', 'data.protoPayload.response.displayName', 'resource.labels.email_id', 'data.resource.labels.email_id') \
)

EVAL-vendor_account = case( \
    isnotnull('resource.labels.project_id'),'resource.labels.project_id',\
    isnotnull('data.resource.labels.project_id'),'data.resource.labels.project_id',\
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), 1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), 1) \
)

EVAL-vendor_product = case( \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "GCP Compute Engine", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'), "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "GCP Compute Engine", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "GCP Firewall", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"pubsub"), "GCP Cloud Pub/Sub", \
    like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage.%"), "GCP Cloud Storage", \
    true(), "GCP Identity Access Management" )

EVAL-vendor_region = case(isnotnull('resource.labels.zone'),'resource.labels.zone',\
                        isnotnull('data.resource.labels.zone'),'data.resource.labels.zone',\
                        isnotnull('resource.labels.location'),'resource.labels.location',\
                        isnotnull('data.resource.labels.location'),'data.resource.labels.location')

## Change_Instance mappings ##
EVAL-image_id = case(match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'resource.labels.instance_id', \
                   match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'data.resource.labels.instance_id', \
                   true(), coalesce('resource.labels.disk_id', 'data.resource.labels.disk_id'))

EVAL-instance_type = case(isnotnull('resource.type'),'resource.type',isnotnull('data.resource.type'),'data.resource.type')

## Network ACLs mappings ##
EVAL-dest_port_range = coalesce('protoPayload.request.alloweds{}.ports{}',\
                              'protoPayload.request.denieds{}.ports{}',\
                              'protoPayload.resourceOriginalState.alloweds{}.ports{}',\
                              'protoPayload.resourceOriginalState.denieds{}.ports{}',\
                              'data.protoPayload.request.alloweds{}.ports{}',\
                              'data.protoPayload.request.denieds{}.ports{}',\
                              'data.protoPayload.resourceOriginalState.alloweds{}.ports{}',\
                              'data.protoPayload.resourceOriginalState.denieds{}.ports{}',\
                              "all")

EVAL-dest_ip_range = coalesce('protoPayload.request.destinationRanges{}',\
                            'protoPayload.resourceOriginalState.destinationRanges{}',\
                            'data.protoPayload.request.destinationRanges{}',\
                            'data.protoPayload.resourceOriginalState.destinationRanges{}',"Not outbound")

EVAL-direction = case('protoPayload.request.direction'="INGRESS", "inbound",\
                    'protoPayload.resourceOriginalState.direction'="INGRESS", "inbound",\
                    'data.protoPayload.request.direction'="INGRESS", "inbound",\
                    'data.protoPayload.resourceOriginalState.direction'="INGRESS", "inbound",\
                    true(),"outbound")

EVAL-network = coalesce('protoPayload.request.network',\
                      'protoPayload.resourceOriginalState.network',\
                      'data.protoPayload.request.network',\
                      'data.protoPayload.resourceOriginalState.network')

EVAL-protocol = coalesce('protoPayload.request.alloweds{}.IPProtocol',\
                       'protoPayload.request.denieds{}.IPProtocol',\
                       'protoPayload.resourceOriginalState.alloweds{}.IPProtocol',\
                       'protoPayload.resourceOriginalState.denieds{}.IPProtocol',\
                       'data.protoPayload.request.alloweds{}.IPProtocol',\
                       'data.protoPayload.request.denieds{}.IPProtocol',\
                       'data.protoPayload.resourceOriginalState.alloweds{}.IPProtocol',\
                       'data.protoPayload.resourceOriginalState.denieds{}.IPProtocol')

EVAL-rule_action = case(isnotnull('protoPayload.request.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('protoPayload.request.denieds{}.IPProtocol'), "deny",\
                      isnotnull('protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny",\
                      isnotnull('data.protoPayload.request.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('data.protoPayload.request.denieds{}.IPProtocol'), "deny",\
                      isnotnull('data.protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('data.protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny")

EVAL-src_ip_range = coalesce('protoPayload.request.sourceRanges{}','protoPayload.resourceOriginalState.sourceRanges{}','data.protoPayload.request.sourceRanges{}',\
                           'data.protoPayload.resourceOriginalState.sourceRanges{}')


# -----------------------------------------------------------------------------
# DATA ACCESS SOURCETYPE - Authentication CIM + Change CIM
# -----------------------------------------------------------------------------
[FAKE:google:gcp:pubsub:audit:data_access]
TRANSFORMS-demo_id = extract_demo_id_indexed
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)\{
TRUNCATE = 999999
TIME_PREFIX = \"timestamp\"\s*:\s*\"
MAX_TIMESTAMP_LOOKAHEAD = 30
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ

TRANSFORMS-set_host = set_host_from_gcp_project

## Extraction ##
REPORT-splunk_ta_gcp_audit_cim_change_updated_user = gcp_change_updated_user1_demo, gcp_change_updated_user2_demo
REPORT-splunk_ta_gcp_audit_cim_change_updated_value = gcp_change_updated_value1_demo, gcp_change_updated_value2_demo


## Aliases ##
FIELDALIAS-splunk_ta_gcp_audit_cim_change_dest_user = updated_user as dest_user

## Eval ##
EVAL-command = coalesce('protoPayload.methodName','data.protoPayload.methodName')

EVAL-dest = case( \
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.request.resource', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.request.resource', \
    'protoPayload.methodName' in ("google.admin.AdminService.changeUserAddress", "google.iam.admin.v1.CreateServiceAccount"), mvindex(split('protoPayload.resourceName', "/"), 1), \
    'data.protoPayload.methodName' in ("google.admin.AdminService.changeUserAddress", "google.iam.admin.v1.CreateServiceAccount"), mvindex(split('data.protoPayload.resourceName', "/"), 1), \
    match('protoPayload.methodName', "^google\.iam\.admin\.v\d+\.(CreateServiceAccountKey|DeleteServiceAccount|PatchServiceAccount|DisableServiceAccount|SetIAMPolicy)$"), 'resource.labels.project_id', \
    match('data.protoPayload.methodName', "^google\.iam\.admin\.v\d+\.(CreateServiceAccountKey|DeleteServiceAccount|PatchServiceAccount|DisableServiceAccount|SetIAMPolicy)$"), 'data.resource.labels.project_id', \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(insert)"), if(severity="ERROR", mvindex(split('protoPayload.resourceName',"/"), -1), 'resource.labels.project_id'), \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(insert)"), if('data.severity'="ERROR", mvindex(split('data.protoPayload.resourceName',"/"), -1), 'data.resource.labels.project_id'), \
    match('protoPayload.methodName', "(v\d+)\.compute\.instances\.(start|reset|delete|attachDisk|detachDisk)"), mvindex(split('protoPayload.resourceName',"/"), -1), \
    match('data.protoPayload.methodName', "(v\d+)\.compute\.instances\.(start|reset|delete|attachDisk|detachDisk)"), mvindex(split('data.protoPayload.resourceName',"/"), -1), \
    true(), coalesce('resource.labels.project_id', 'data.resource.labels.project_id', mvindex(split('protoPayload.resourceName', "/"), 1), mvindex(split('data.protoPayload.resourceName', "/"), 1), \
    'resource.labels.project_id','data.resource.labels.project_id', \
    'protoPayload.resourceName', 'protoPayload.resourceName', \
    'protoPayload.serviceName','data.protoPayload.serviceName') \
)

EVAL-object = case( \
    'protoPayload.methodName'="google.login.LoginService.logout", 'protoPayload.authenticationInfo.principalEmail',\
    'data.protoPayload.methodName'="google.login.LoginService.logout", 'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="storage.objects.update", 'resource.labels.bucket_name',\
    'data.protoPayload.methodName'="storage.objects.update", 'data.resource.labels.bucket_name',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('protoPayload.methodName',"google.admin.AdminService.%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService.%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    like('protoPayload.methodName',"google.iam.admin.v%") AND isnotnull('resource.labels.email_id'),'resource.labels.email_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v%") AND isnotnull('data.resource.labels.email_id'), 'data.resource.labels.email_id',\
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.resourceName', \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.resourceName', \
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), -1),\
    isnotnull('data.protoPayload.resourceName'), mvindex(split('data.protoPayload.resourceName', "/"), -1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), -1), \
    'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'resource.labels.email_id', \
    'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'data.resource.labels.email_id' \
)

EVAL-object_id = case( \
    like('protoPayload.methodName',"google.iam.admin.%.CreateServiceAccount"), if(isnotnull('protoPayload.request.service_account.description'), 'resource.labels.unique_id', 'protoPayload.resourceName'),\
    like('data.protoPayload.methodName',"google.iam.admin.%.CreateServiceAccount"), if(isnotnull('data.protoPayload.request.service_account.description'), 'data.resource.labels.unique_id', 'data.protoPayload.resourceName'),\
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount|PatchServiceAccount)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount|PatchServiceAccount)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateServiceAccountKey)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateServiceAccountKey)"), 'data.protoPayload.resourceName',\
    like('protoPayload.methodName',"google.pubsub.%.Subscriber.DeleteSubscription"), 'protoPayload.resourceName',\
    like('data.protoPayload.methodName',"google.pubsub.%.Subscriber.DeleteSubscription"), 'data.protoPayload.resourceName',\
    like('protoPayload.methodName',"google.pubsub.%.Publisher.CreateTopic"), 'protoPayload.resourceName', \
    like('data.protoPayload.methodName',"google.pubsub.%.Publisher.CreateTopic"), 'data.protoPayload.resourceName', \
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(UndeleteRole|CreateRole|DeleteRole|UpdateRole)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(UndeleteRole|CreateRole|DeleteRole|UpdateRole)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"storage\.buckets\.(create|delete|update)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"storage\.buckets\.(create|delete|update)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName',"storage\.objects\.(update)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"storage\.objects\.(update)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), if(severity IN ("ERROR"), 'protoPayload.resourceName', 'resource.labels.instance_id'), \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), if('data.severity' IN ("ERROR"), 'data.protoPayload.resourceName', 'data.resource.labels.instance_id'), \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'resource.labels.disk_id', \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'data.resource.labels.disk_id', \
    'protoPayload.methodName'="Subscriber.InternalExpireInactiveSubscription", 'protoPayload.resourceName',\
    'data.protoPayload.methodName'="Subscriber.InternalExpireInactiveSubscription", 'data.protoPayload.resourceName',\
    'protoPayload.methodName'="storage.setIamPermissions", 'protoPayload.resourceName',\
    'data.protoPayload.methodName'="storage.setIamPermissions", 'data.protoPayload.resourceName',\
    'protoPayload.methodName'="SetIamPolicy", coalesce('resource.labels.unique_id', 'protoPayload.resourceName'),\
    'data.protoPayload.methodName'="SetIamPolicy", coalesce('data.resource.labels.unique_id', 'data.protoPayload.resourceName'),\
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    like('protoPayload.methodName',"google.admin.AdminService.%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService.%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    isnotnull('data.resource.labels.disk_id'),'data.resource.labels.disk_id',\
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.resourceName', \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.resourceName', \
    like('protoPayload.methodName',"google.iam.admin.v1%") AND isnotnull('resource.labels.unique_id'),'resource.labels.unique_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v1%") AND isnotnull('data.resource.labels.unique_id'), 'data.resource.labels.unique_id',\
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), -1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), -1), \
    'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'resource.labels.unique_id', \
    'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'data.resource.labels.unique_id', \
    true(), coalesce('protoPayload.resourceName','data.protoPayload.resourceName') \
)

EVAL-object_path = case( \
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount)"), mvjoin(mvindex(split('protoPayload.request.name', "/"), 0, 2), "/")+"/" , \
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DeleteServiceAccount|DisableServiceAccount)"), mvjoin(mvindex(split('data.protoPayload.request.name', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), mvjoin(mvindex(split('protoPayload.request.resource', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "google\.iam\.admin\.v\d+\.SetIAMPolicy"), mvjoin(mvindex(split('data.protoPayload.request.resource', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.admin\.AdminService\.(changePassword|removeRecoveryPhone)"), 'protoPayload.resourceName', \
    match('data.protoPayload.methodName',"google\.admin\.AdminService\.(changePassword|removeRecoveryPhone)"), 'data.protoPayload.resourceName', \
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"Subscriber\.InternalExpireInactiveSubscription"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"Subscriber\.InternalExpireInactiveSubscription"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.resourceName',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.resourceName',\
    match('protoPayload.methodName', "storage\.buckets\.(create|delete|update)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.buckets\.(create|delete|update)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "storage\.objects\.(update)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.objects\.(update)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "storage\.(setIamPermissions)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('data.protoPayload.methodName', "storage\.(setIamPermissions)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 2), "/")+"/", \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), mvjoin(mvindex(split('data.protoPayload.resourceName', "/"), 0, 4), "/")+"/" , \
    match('protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 3), "/")+"/" , \
    match('data.protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), mvjoin(mvindex(split('protoPayload.resourceName', "/"), 0, 3), "/")+"/" , \
    like('protoPayload.methodName',"google.iam.admin.%"), mvjoin(mvindex(split('protoPayload.response.name', "/"), 0, 2), "/")+"/" , \
    like('data.protoPayload.methodName',"google.iam.admin.%"), mvjoin(mvindex(split('data.protoPayload.response.name', "/"), 0, 2), "/")+"/", \
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.request.parent', \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.request.parent', \
    'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", mvjoin(mvindex(split('protoPayload.request.name', "/"), 0, 2), "/")+"/", \
    'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", mvjoin(mvindex(split('data.protoPayload.request.name', "/"), 0, 2), "/")+"/" \
)

EVAL-result = case( \
    'severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), 'protoPayload.methodName', \
    'severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), coalesce('protoPayload.response.error.errors{}.reason', 'protoPayload.response.error.message', 'protoPayload.status.message'), \
    'data.severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), 'data.protoPayload.methodName', \
    'data.severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), coalesce('data.protoPayload.response.error.errors{}.reason', 'data.protoPayload.response.error.message', 'data.protoPayload.status.message'), \
    'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'protoPayload.status.message', \
    'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'data.protoPayload.status.message' \
)

EVAL-result_id = coalesce( \
    'protoPayload.response.error.code',\
    'data.protoPayload.response.error.code',\
    'protoPayload.status.code',\
    'data.protoPayload.status.code' \
)

EVAL-src_ip = coalesce('protoPayload.requestMetadata.callerIp','data.protoPayload.requestMetadata.callerIp')
EVAL-user_agent = coalesce('protoPayload.requestMetadata.callerSuppliedUserAgent','data.protoPayload.requestMetadata.callerSuppliedUserAgent')

EVAL-user_id = case( \
    match('resource.type',"service_account"),'resource.labels.unique_id',\
    match('data.resource.type',"service_account"),'data.resource.labels.unique_id',\
    isnotnull('protoPayload.authenticationInfo.principalEmail'),'protoPayload.authenticationInfo.principalEmail',\
    isnotnull('data.protoPayload.authenticationInfo.principalEmail'),'data.protoPayload.authenticationInfo.principalEmail', \
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.authenticationInfo.principalEmail', \
    true(), coalesce('resource.labels.unique_id','data.resource.labels.unique_id') \
)

EVAL-user_type = case( \
    coalesce('protoPayload.methodName', 'data.protoPayload.methodName')="SetIamPolicy", "service_account", \
    match('resource.type',"pubsub_subscription"),"service_account",match('data.resource.type',"pubsub_subscription"),"service_account",\
    match('resource.type',"service_account"),"service_account",match('data.resource.type',"service_account"),"service_account" )

EVAL-action = case( \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.buckets.setIamPolicy","modified",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.setIamPermissions","modified",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="beta.compute.firewalls.insert","modified",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.logging.v2.LoggingServiceV2.ListLogs", "read", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.iam.admin.v1.GetServiceAccountKey", "read", \
    severity in ("INFO", "NOTICE"), "success", \
    'data.severity' in ("INFO", "NOTICE"), "success", \
    severity="ERROR", "failure", \
    'data.severity'="ERROR", "failure",\
    isnotnull('protoPayload.request.alloweds{}.IPProtocol'), "allow",\
    isnotnull('protoPayload.request.denieds{}.IPProtocol'), "deny",\
    isnotnull('protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
    isnotnull('protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny",\
    isnotnull('data.protoPayload.request.alloweds{}.IPProtocol'), "allow",\
    isnotnull('data.protoPayload.request.denieds{}.IPProtocol'), "deny",\
    isnotnull('data.protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
    isnotnull('data.protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "setiampermissions") AND match('resource.type',"service_account"), "modified", \
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "setiampermissions"),"acl_modified",\
    like(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "%.createserviceaccountkey"),"modified",\
    like(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "%.disableserviceaccount"),"modified",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(create|insert|undelete)"),"created",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="Subscriber.InternalExpireInactiveSubscription","deleted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "delete"),"deleted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "reset"),"restarted",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(start|enable)"),"started",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(stop|disable)"),"stopped",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "(update|patch|attachdisk|detachdisk|set|change|remove|add)"), "modified",\
    match(lower(coalesce('protoPayload.methodName','data.protoPayload.methodName')), "list"),"logs_read",\
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'), "google.login.LoginService.logout"),"logoff",\
    true(), "unknown" )

EVAL-change_type = case( \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Publisher\.CreateTopic"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"Subscriber\.InternalExpireInactiveSubscription"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Subscriber\.(DeleteSubscription)"), "data", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "Virtual Server", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "Virtual Server", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "firewall", \
    like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage.%"), "storage", \
    true(), "AAA", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.logging.v2.LoggingServiceV2.ListLogs", "logging", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.iam.admin.v1.GetServiceAccountKey", "AAA" \
)

EVAL-object_attrs = case( \
    coalesce('protoPayload.methodName', 'data.protoPayload.methodName')="SetIamPolicy", "policy", \
    like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google.iam.admin.%.CreateServiceAccountKey"), "ServiceAccountKey", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.changePassword", "password", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.removeRecoveryPhone", "RECOVERY_PHONE", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.addRecoveryEmail", "RECOVERY_EMAIL", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.admin.AdminService.changeUserAddress", "USER_ADDRESS", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="login.googleapis.com", "login session",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.login.LoginService.logout", "login session",\
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", mvindex(split('protoPayload.resourceName', "/"),-1), \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", mvindex(split('data.protoPayload.resourceName', "/"),-1), \
    true(), coalesce('resource.type', 'data.resource.type', "project") \
)

EVAL-object_category = case( \
    'protoPayload.methodName' in ("google.pubsub.v1.Publisher.CreateTopic", "Subscriber.InternalExpireInactiveSubscription"), 'resource.type', \
    'data.protoPayload.methodName' in ("google.pubsub.v1.Publisher.CreateTopic", "Subscriber.InternalExpireInactiveSubscription"), 'data.resource.type', \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="storage.setIamPermissions", "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage\.objects\.(update)"), "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage\.buckets\.(create|delete|update)"), "bucket", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.iam\.admin\.v\d+\.(UndeleteRole|DeleteRole|CreateRole|UpdateRole)"), "role", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "firewall", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "disk", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "instance", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), "pubsub_subscription", \
    match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"google\.iam\.admin\.v\d+\.CreateServiceAccountKey"), "user", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="SetIamPolicy", "user", \
    coalesce('resource.type', 'data.resource.type')="service_account", "user",\
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.login.LoginService.logout", "user",\
    coalesce('protoPayload.metadata.event{}.eventType', 'data.protoPayload.metadata.event{}.eventType')="USER_SETTINGS","user", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.logging.v2.LoggingServiceV2.ListLogs", "logs", \
    coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.iam.admin.v1.GetServiceAccountKey", "user" \
)

EVAL-resource_type = case(match('protoPayload.metadata.event{}.eventType',"USER_SETTINGS"),"iam_user", \
                        match('data.protoPayload.metadata.event{}.eventType',"USER_SETTINGS"),"iam_user", \
                        true(), coalesce('resource.type', 'data.resource.type'))

EVAL-src_user = case( \
    ('protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'protoPayload.authenticationInfo.principalEmail',\
    ('data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'data.protoPayload.authenticationInfo.principalEmail', \
    match('resource.type',"service_account"),'protoPayload.authenticationInfo.principalEmail',\
    match('data.resource.type',"service_account"),'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.authenticationInfo.principalEmail', \
    true(), "No src_user" )

EVAL-src_user_name = case( \
    ('protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'protoPayload.authenticationInfo.principalEmail',\
    ('data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS" OR match(lower(command), "setiampermissions")), 'data.protoPayload.authenticationInfo.principalEmail', \
    match('resource.type',"service_account"),'protoPayload.authenticationInfo.principalEmail',\
    match('data.resource.type',"service_account"),'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="SetIamPolicy", 'data.protoPayload.authenticationInfo.principalEmail', \
    true(), "No src_user_name" )

EVAL-status = case('severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), "success",\
                 'severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), "failure",\
                 'data.severity' IN ("DEBUG","INFO","NOTICE", "WARNING"), "success",\
                 'data.severity' IN ("ERROR","CRITICAL","ALERT", "EMERGENCY"), "failure")

EVAL-user = case( \
    'protoPayload.metadata.event{}.eventType'="USER_SETTINGS", updated_user,\
    'data.protoPayload.metadata.event{}.eventType'="USER_SETTINGS", updated_user,\
    'protoPayload.methodName'="storage.setIamPermissions",'protoPayload.authenticationInfo.principalEmail',\
    'data.protoPayload.methodName'="storage.setIamPermissions",'data.protoPayload.authenticationInfo.principalEmail',\
    match(lower('protoPayload.methodName'), "(createserviceaccount|deleteserviceaccount|patchserviceaccount|disableserviceaccount|getserviceaccountkey)"), 'resource.labels.email_id',\
    match(lower('data.protoPayload.methodName'), "(createserviceaccount|deleteserviceaccount|patchserviceaccount|disableserviceaccount|getserviceaccountkey)"), 'data.resource.labels.email_id',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    isnotnull('protoPayload.authenticationInfo.principalEmail'),'protoPayload.authenticationInfo.principalEmail',\
    isnotnull('data.protoPayload.authenticationInfo.principalEmail'),'data.protoPayload.authenticationInfo.principalEmail',\
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('protoPayload.methodName',"google.admin.AdminService%"),'protoPayload.metadata.event{}.parameter{}.value',\
    like('data.protoPayload.methodName',"google.admin.AdminService%"),'data.protoPayload.metadata.event{}.parameter{}.value',\
    like('protoPayload.methodName',"google.iam.admin.v%"),'resource.labels.email_id',\
    like('data.protoPayload.methodName',"google.iam.admin.v%"),'data.resource.labels.email_id',\
    true(), coalesce('data.resource.labels.email_id','protoPayload.authenticationInfo.principalSubject') \
)

EVAL-user_name = case( \
    match('protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateRole|UndeleteRole|DeleteRole|UpdateRole)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(CreateRole|UndeleteRole|DeleteRole|UpdateRole)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "google\.iam\.admin\.v\d+\.(DisableServiceAccount)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.iam\.admin\.v\d+\.(DisableServiceAccount)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Publisher\.(CreateTopic)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.pubsub\.v\d+\.Subscriber\.DeleteSubscription"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"storage\.buckets\.(create|delete|update|setIamPolicy)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"storage\.buckets\.(create|delete|update|setIamPolicy)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"storage\.objects\.(update)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"storage\.objects\.(update)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "storage\.(setIamPermissions)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "storage\.(setIamPermissions)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"google\.login\.LoginService\.(logout)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.disks\.(delete|insert)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    match('protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), 'protoPayload.authenticationInfo.principalEmail',\
    match('data.protoPayload.methodName',"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), 'data.protoPayload.authenticationInfo.principalEmail',\
    'protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    'data.protoPayload.methodName'="SetIamPolicy", mvindex(split(mvindex('data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member', 0), ":"), 1), \
    like('protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    like('data.protoPayload.methodName',"google.iam.admin.v%.SetIAMPolicy"), mvindex(split(mvindex(mvdedup(mvfilter(match('data.protoPayload.request.policy.bindings{}.members{}',"^user:"))), 0), ":"), 1),\
    'protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.authenticationInfo.principalEmail', \
    'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.authenticationInfo.principalEmail', \
    like('protoPayload.methodName',"google.admin.AdminService%"),mvindex('protoPayload.metadata.event{}.parameter{}.value',0),\
    like('data.protoPayload.methodName',"google.admin.AdminService%"),mvindex('data.protoPayload.metadata.event{}.parameter{}.value',0),\
    true(), coalesce('protoPayload.response.display_name','data.protoPayload.response.display_name', 'protoPayload.response.displayName', 'data.protoPayload.response.displayName', 'resource.labels.email_id', 'data.resource.labels.email_id'), \
    'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'resource.labels.email_id', \
    'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'data.resource.labels.email_id' \
)

EVAL-vendor_region = case(isnotnull('resource.labels.zone'),'resource.labels.zone',\
                        isnotnull('data.resource.labels.zone'),'data.resource.labels.zone',\
                        isnotnull('resource.labels.location'),'resource.labels.location',\
                        isnotnull('data.resource.labels.location'),'data.resource.labels.location')

## Change_Instance mappings ##
EVAL-image_id = case(match('protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'resource.labels.instance_id', \
                   match('data.protoPayload.methodName', "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), 'data.resource.labels.instance_id', \
                   true(), coalesce('resource.labels.disk_id', 'data.resource.labels.disk_id'))

EVAL-instance_type = case(isnotnull('resource.type'),'resource.type',isnotnull('data.resource.type'),'data.resource.type')

## Network ACLs mappings ##
EVAL-dest_port_range = coalesce('protoPayload.request.alloweds{}.ports{}',\
                              'protoPayload.request.denieds{}.ports{}',\
                              'protoPayload.resourceOriginalState.alloweds{}.ports{}',\
                              'protoPayload.resourceOriginalState.denieds{}.ports{}',\
                              'data.protoPayload.request.alloweds{}.ports{}',\
                              'data.protoPayload.request.denieds{}.ports{}',\
                              'data.protoPayload.resourceOriginalState.alloweds{}.ports{}',\
                              'data.protoPayload.resourceOriginalState.denieds{}.ports{}',\
                              "all")

EVAL-dest_ip_range = coalesce('protoPayload.request.destinationRanges{}',\
                            'protoPayload.resourceOriginalState.destinationRanges{}',\
                            'data.protoPayload.request.destinationRanges{}',\
                            'data.protoPayload.resourceOriginalState.destinationRanges{}',"Not outbound")

EVAL-direction = case('protoPayload.request.direction'="INGRESS", "inbound",\
                    'protoPayload.resourceOriginalState.direction'="INGRESS", "inbound",\
                    'data.protoPayload.request.direction'="INGRESS", "inbound",\
                    'data.protoPayload.resourceOriginalState.direction'="INGRESS", "inbound",\
                    true(),"outbound")

EVAL-network = coalesce('protoPayload.request.network',\
                      'protoPayload.resourceOriginalState.network',\
                      'data.protoPayload.request.network',\
                      'data.protoPayload.resourceOriginalState.network')

EVAL-protocol = coalesce('protoPayload.request.alloweds{}.IPProtocol',\
                       'protoPayload.request.denieds{}.IPProtocol',\
                       'protoPayload.resourceOriginalState.alloweds{}.IPProtocol',\
                       'protoPayload.resourceOriginalState.denieds{}.IPProtocol',\
                       'data.protoPayload.request.alloweds{}.IPProtocol',\
                       'data.protoPayload.request.denieds{}.IPProtocol',\
                       'data.protoPayload.resourceOriginalState.alloweds{}.IPProtocol',\
                       'data.protoPayload.resourceOriginalState.denieds{}.IPProtocol')

EVAL-rule_action = case(isnotnull('protoPayload.request.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('protoPayload.request.denieds{}.IPProtocol'), "deny",\
                      isnotnull('protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny",\
                      isnotnull('data.protoPayload.request.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('data.protoPayload.request.denieds{}.IPProtocol'), "deny",\
                      isnotnull('data.protoPayload.resourceOriginalState.alloweds{}.IPProtocol'), "allow",\
                      isnotnull('data.protoPayload.resourceOriginalState.denieds{}.IPProtocol'), "deny")

EVAL-src_ip_range = coalesce('protoPayload.request.sourceRanges{}','protoPayload.resourceOriginalState.sourceRanges{}','data.protoPayload.request.sourceRanges{}',\
                           'data.protoPayload.resourceOriginalState.sourceRanges{}')

## Authentication DM ##
EVAL-app = coalesce('protoPayload.serviceName','data.protoPayload.serviceName')
EVAL-authentication_service = coalesce('protoPayload.serviceName','data.protoPayload.serviceName')

EVAL-dvc = case('protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'protoPayload.serviceName', \
              'data.protoPayload.methodName'="google.logging.v2.LoggingServiceV2.ListLogs", 'data.protoPayload.serviceName', \
              'protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'protoPayload.serviceName', \
              'data.protoPayload.methodName'="google.iam.admin.v1.GetServiceAccountKey", 'data.protoPayload.serviceName', \
              'protoPayload.methodName'="SetIamPolicy", "iam.googleapis.com", \
              'data.protoPayload.methodName'="SetIamPolicy", "iam.googleapis.com", \
              true(), coalesce('protoPayload.serviceName', 'data.protoPayload.serviceName') \
          )

EVAL-reason = coalesce('protoPayload.status.message','data.protoPayload.status.message')
EVAL-signature = coalesce('protoPayload.methodName','data.protoPayload.methodName')

EVAL-src = coalesce('protoPayload.requestMetadata.callerIp','data.protoPayload.requestMetadata.callerIp')

EVAL-vendor_account = case( \
    isnotnull('resource.labels.project_id'),'resource.labels.project_id',\
    isnotnull('data.resource.labels.project_id'),'data.resource.labels.project_id',\
    isnotnull('protoPayload.resourceName'), mvindex(split('protoPayload.resourceName', "/"), 1),\
    true(), mvindex(split('data.protoPayload.resourceName', "/"), 1) \
)

EVAL-vendor_product = case( \
                        coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.logging.v2.LoggingServiceV2.ListLogs", "GCP", \
                        coalesce('protoPayload.methodName','data.protoPayload.methodName')="google.iam.admin.v1.GetServiceAccountKey", "GCP Identity Access Management", \
                        match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.disks\.(delete|insert)"), "GCP Compute Engine", \
                        match(coalesce('protoPayload.methodName','data.protoPayload.methodName'), "(v\d+|beta)\.compute\.instances\.(start|reset|insert|delete|attachDisk|detachDisk)"), "GCP Compute Engine", \
                        match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"(v\d+|beta)\.compute\.firewalls\.(insert|patch|delete)"), "GCP Firewall", \
                        match(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"pubsub"), "GCP Cloud Pub/Sub", \
                        like(coalesce('protoPayload.methodName','data.protoPayload.methodName'),"storage.%"), "GCP Cloud Storage", \
                        true(), "GCP Identity Access Management" \
)



##############################################################################################################
# CISCO MERAKI
##############################################################################################################

[FAKE:meraki:securityappliances]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MX"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Security Appliance"
category = Network & Security
description = Cisco Meraki MX Security Appliance logs for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Security Appliance (MX)
EVAL-action = case(type="firewall" AND match('eventData.pattern',"allow"), "allowed", type="firewall" AND match('eventData.pattern',"deny"), "blocked", type="security_event" AND 'eventData.blocked'="true", "blocked", type="security_event" AND 'eventData.blocked'="false", "allowed", type="vpn_connectivity_change", if('eventData.connectivity'="true", "started", "stopped"), type="sd_wan_failover", "modified", 1=1, "unknown")
EVAL-app = if(type IN("firewall", "url", "security_event"), "Cisco Meraki", NULL)
EVAL-dest = case(type="firewall", 'eventData.dst', type="url", 'eventData.dst', type="security_event", coalesce('eventData.destIp', 'eventData.clientIp'), type IN("vpn_connectivity_change", "vpn_tunnel_status", "sd_wan_health", "sd_wan_failover"), if(deviceName="", deviceSerial, deviceName), 1=1, NULL)
EVAL-dest_ip = case(type="firewall", mvindex(split('eventData.dst', ":"), 0), type="url", mvindex(split('eventData.dst', ":"), 0), type="security_event", coalesce('eventData.destIp', 'eventData.clientIp'))
EVAL-dest_port = case(type="firewall", 'eventData.dport', type="security_event", 'eventData.destPort')
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-dvc_ip = NULL
EVAL-protocol = case(type="firewall", 'eventData.protocol', type="security_event", 'eventData.protocol')
EVAL-severity = case(type="security_event", coalesce('eventData.priority', "medium"), 1=1, NULL)
EVAL-signature = case(type="security_event", coalesce('eventData.message', description), type="firewall", description, 1=1, NULL)
EVAL-signature_id = case(type="security_event", coalesce('eventData.ruleId', 'eventData.signature'))
EVAL-src = case(type="firewall", 'eventData.src', type="url", 'eventData.src', type="security_event", 'eventData.srcIp', type IN("vpn_connectivity_change", "vpn_tunnel_status", "sd_wan_health", "sd_wan_failover"), if(deviceName="", deviceSerial, deviceName), 1=1, NULL)
EVAL-src_ip = case(type="firewall", mvindex(split('eventData.src', ":"), 0), type="url", mvindex(split('eventData.src', ":"), 0), type="security_event", 'eventData.srcIp')
EVAL-src_mac = if(type="firewall", 'eventData.mac', NULL)
EVAL-src_port = case(type="firewall", 'eventData.sport', type="security_event", 'eventData.srcPort')
EVAL-status = case(type="firewall", if(match('eventData.pattern',"allow"), "success", "failure"), type="security_event", if('eventData.blocked'="true", "blocked", "allowed"), type="vpn_connectivity_change", if('eventData.connectivity'="true", "success", "failure"), type IN("sd_wan_health"), 'eventData.status', 1=1, NULL)
EVAL-transport = case(type="firewall", lower('eventData.protocol'), type="security_event", lower('eventData.protocol'))
EVAL-url = if(type="url", 'eventData.url', NULL)
EVAL-user = if(type="url", 'eventData.agent', NULL)

# Lookup-based enrichments
LOOKUP-meraki_securityappliances_action_type = cisco_meraki_securityappliances_action_lookup meraki_event_type OUTPUTNEW action AS lookup_action
LOOKUP-meraki_securityappliances_change_type_result_type = cisco_meraki_securityappliances_change_type_result_lookup meraki_event_type OUTPUTNEW change_type, result
LOOKUP-meraki_securityappliances_object_object_category_type = cisco_meraki_securityappliances_object_object_category_lookup meraki_event_type OUTPUTNEW object, object_category



[FAKE:meraki:accesspoints]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MR"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Access Point"
category = Network & Security
description = Cisco Meraki MR Access Point logs for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Access Points (MR)
EVAL-app = if(type IN("8021x_eap_success", "8021x_eap_failure", "wpa_auth", "rogue_ssid_detected", "association", "disassociation"), "Cisco Meraki", NULL)
EVAL-description = if(type IN("rogue_ssid_detected", "health_alert"), description, NULL)
EVAL-dest = case(type IN("association", "disassociation", "wpa_auth", "rogue_ssid_detected"), if(deviceName="", deviceSerial, deviceName), 1=1, NULL)
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-severity = case(type="rogue_ssid_detected", "medium", type="health_alert", coalesce('eventData.severity', "medium"), 1=1, NULL)
EVAL-src = case(type IN("association", "disassociation"), clientMac, type IN("8021x_eap_success", "8021x_eap_failure"), clientDescription, type="wpa_auth", clientMac, 1=1, NULL)
EVAL-src_ip = case(type IN("8021x_eap_success", "8021x_eap_failure"), clientIp, type="association", clientIp)
EVAL-src_mac = if(type IN("association", "disassociation", "8021x_eap_success", "8021x_eap_failure", "wpa_auth"), lower(clientMac), NULL)
EVAL-ssid = coalesce('eventData.ssid', NULL)
EVAL-status = case(type="8021x_eap_success", "success", type="8021x_eap_failure", "failure", type="association", "success", type="disassociation", "success", type="wpa_auth", "success", 1=1, NULL)
EVAL-type = case(type="rogue_ssid_detected", "warning", type="health_alert", "alert", 1=1, NULL)
EVAL-user = case(type IN("wpa_auth", "disassociation", "association"), clientDescription, type IN("8021x_eap_success", "8021x_eap_failure"), 'eventData.identity')

# Lookup-based enrichments
LOOKUP-meraki_accesspoints_action_type = cisco_meraki_accesspoints_action_lookup meraki_event_type OUTPUTNEW action
LOOKUP-meraki_accesspoints_change_type_object_object_category_result_type = cisco_meraki_accesspoints_change_type_object_object_category_result_lookup meraki_event_type OUTPUTNEW change_type, object, object_category, result
LOOKUP-meraki_accesspoints_object_attrs_type = cisco_meraki_accesspoints_object_attrs_lookup meraki_event_type OUTPUTNEW object_attrs
LOOKUP-mac_by_client = mac_inventory mac_address AS clientMac OUTPUT ip_address AS client_ip, hostname AS client_hostname, username AS client_username, department AS client_department

[FAKE:meraki:switches]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MS"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Switch"
category = Network & Security
description = Cisco Meraki MS Switch logs for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Switches (MS)
EVAL-action = case(type="stp_change" AND 'eventData.state'!="designated", "stopped", type="stp_change" AND 'eventData.state'="designated", "started", 1=1, NULL)
EVAL-dest = case(type IN("port_status", "stp_change", "8021x_auth"), if(deviceName="", deviceSerial, deviceName))
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-object_attrs = case(type="port_status", 'eventData.status', type="stp_change", 'eventData.state')
EVAL-object_category = if(type IN("port_status", "stp_change", "8021x_auth"), "switch", NULL)
EVAL-object_id = case(type IN("port_status", "stp_change", "8021x_auth"), 'eventData.port')
EVAL-result = case(type="port_status", 'eventData.status', type="stp_change" AND 'eventData.state'!="designated", "stopped", type="stp_change" AND 'eventData.state'="designated", "started", type="8021x_auth", 'eventData.status')
EVAL-src = case(type IN("port_status", "stp_change", "8021x_auth"), if(deviceName="", deviceSerial, deviceName))
EVAL-src_mac = if(type="8021x_auth", lower('eventData.client_mac'), NULL)
EVAL-status = case(type="port_status", "success", type="stp_change", 'eventData.state', type="8021x_auth", 'eventData.status', 1=1, NULL)

# Lookup-based enrichments
LOOKUP-meraki_switches_action_type = cisco_meraki_switches_action_lookup meraki_event_type OUTPUTNEW action
LOOKUP-meraki_switches_change_type_object_type = cisco_meraki_switches_change_type_object_lookup meraki_event_type OUTPUTNEW change_type, object
LOOKUP-meraki_switches_result_type = cisco_meraki_switches_result_lookup meraki_event_type OUTPUTNEW result

[FAKE:meraki:cameras]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MV"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Smart Camera"
category = Network & Security
description = Cisco Meraki MV Smart Camera logs for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Cameras (MV)
EVAL-action = case(type="motion_detected", "detected", type="person_detected", "detected", type="health_status", "reported", 1=1, NULL)
EVAL-change_type = if(type="health_status", "system status", NULL)
EVAL-dest = if(type IN("motion_detected", "person_detected", "analytics", "health_status"), if(deviceName="", deviceSerial, deviceName), NULL)
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-object = if(type IN("motion_detected", "person_detected", "analytics", "health_status"), "camera", NULL)
EVAL-object_attrs = case(type="motion_detected", 'eventData.zone', type="person_detected", 'eventData.count', type="analytics", 'eventData.people_count')
EVAL-object_category = case(type="motion_detected", "motion", type="person_detected", "person", type="analytics", "analytics", type="health_status", "health")
EVAL-src = if(type IN("motion_detected", "person_detected", "analytics", "health_status"), if(deviceName="", deviceSerial, deviceName), NULL)
EVAL-status = if(type IN("motion_detected", "person_detected", "analytics", "health_status"), "success", NULL)

# Lookup-based enrichments
LOOKUP-meraki_camera_type = cisco_meraki_cameras_lookup meraki_event_type OUTPUTNEW action AS lookup_action, change_type AS lookup_change_type, object_category AS lookup_object_category, result

[FAKE:meraki:sensors]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MT"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Sensor"
category = Network & Security
description = Cisco Meraki MT Sensor logs for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Sensors (MT)
EVAL-action = "reported"
EVAL-dest = if(deviceName="", deviceSerial, deviceName)
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-object = "sensor"
EVAL-object_attrs = case(type="sensor_reading", coalesce('eventData.value_f', 'eventData.value_c', 'eventData.value', 'eventData.status'))
EVAL-object_category = case(type="sensor_reading", coalesce('eventData.type', category))
EVAL-src = if(deviceName="", deviceSerial, deviceName)
EVAL-status = "success"

[FAKE:meraki:accesspoints:health]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MR"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Access Point Health"
category = Network & Security
description = Cisco Meraki MR Access Point health metrics for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  AP Health
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-dest = if(deviceName="", deviceSerial, deviceName)
EVAL-src = if(deviceName="", deviceSerial, deviceName)
EVAL-status = "success"

[FAKE:meraki:switches:health]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = JSON
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6NZ
TIME_PREFIX = occurredAt\": \"
MAX_TIMESTAMP_LOOKAHEAD = 27
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Meraki MS"
EVAL-vendor = "Cisco"
EVAL-product = "Meraki Switch Health"
category = Network & Security
description = Cisco Meraki MS Switch health metrics for the FAKE tshirt company
TRANSFORMS-set_host = set_meraki_host_from_devicename

# CIM field alias
FIELDALIAS-meraki_event_type = type AS meraki_event_type

# CIM field extractions  Switch Health
EVAL-dvc = if(deviceName="", deviceSerial, deviceName)
EVAL-dest = if(deviceName="", deviceSerial, deviceName)
EVAL-src = if(deviceName="", deviceSerial, deviceName)
EVAL-status = "success"


##############################################################################################################
# CISCO CATALYST CENTER - Assurance API (Device/Network/Client Health + Issues)
##############################################################################################################

[FAKE:cisco:catalyst:devicehealth]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3NZ
TIME_PREFIX = "timestamp"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Catalyst Center"
EVAL-app = "cisco_catalyst_center"

[FAKE:cisco:catalyst:networkhealth]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3NZ
TIME_PREFIX = "timestamp"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Catalyst Center"
EVAL-app = "cisco_catalyst_center"

[FAKE:cisco:catalyst:clienthealth]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3NZ
TIME_PREFIX = "timestamp"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Catalyst Center"
EVAL-app = "cisco_catalyst_center"

[FAKE:cisco:catalyst:issue]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3NZ
TIME_PREFIX = "timestamp"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Catalyst Center"
EVAL-app = "cisco_catalyst_center"


##############################################################################################################
# CISCO ACI - APIC REST API (Faults, Events, Audit)
##############################################################################################################

[FAKE:cisco:aci:fault]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%z
TIME_PREFIX = "created"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco ACI"
EVAL-app = "cisco_aci"

[FAKE:cisco:aci:event]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%z
TIME_PREFIX = "created"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco ACI"
EVAL-app = "cisco_aci"

[FAKE:cisco:aci:audit]
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%z
TIME_PREFIX = "created"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 999999
EVAL-vendor_product = "Cisco ACI"
EVAL-app = "cisco_aci"


##############################################################################################################
# CISCO CATALYST - IOS-XE Syslog
##############################################################################################################

[FAKE:cisco:ios]
TRANSFORMS-demo_id = extract_demo_id_indexed
TRANSFORMS-host_for_catalyst = catalyst_host_extraction
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %Y %H:%M:%S.%3N
TIME_PREFIX = >\d+:\s+\w[\w-]+:\s+
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 999999
# IOS-XE syslog with PRI: <189>seq: HOSTNAME: Mon DD YYYY HH:MM:SS.mmm: %FACILITY-SEV-MNEMONIC: Message
FIELDALIAS-action_for_catalyst = mnemonic AS action
EVAL-vendor_product = "Cisco IOS"
EVAL-app = "cisco_ios"


##############################################################################################################
# CISCO SECURE ACCESS - Umbrella DNS
##############################################################################################################

[FAKE:cisco:umbrella:dns]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^"
MAX_TIMESTAMP_LOOKAHEAD = 21
TRUNCATE = 999999
# Umbrella DNS v10 CSV: all fields double-quoted, comma-delimited
FIELDALIAS-user_for_umbrella_dns = Most_Granular_Identity AS user
FIELDALIAS-src_for_umbrella_dns = InternalIp AS src
FIELDALIAS-action_for_umbrella_dns = Action AS action
EVAL-vendor_product = "Cisco Umbrella"
EVAL-app = "umbrella_dns"


##############################################################################################################
# CISCO SECURE ACCESS - Umbrella Proxy (SWG)
##############################################################################################################

[FAKE:cisco:umbrella:proxy]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^"
MAX_TIMESTAMP_LOOKAHEAD = 21
TRUNCATE = 999999
# Umbrella Proxy v5 CSV: all fields double-quoted, comma-delimited
FIELDALIAS-user_for_umbrella_proxy = Policy_Identity_Label AS user
FIELDALIAS-src_for_umbrella_proxy = Internal_Client_IP AS src
FIELDALIAS-action_for_umbrella_proxy = Action AS action
FIELDALIAS-url_for_umbrella_proxy = URL AS url
EVAL-vendor_product = "Cisco Umbrella"
EVAL-app = "umbrella_proxy"


##############################################################################################################
# CISCO SECURE ACCESS - Umbrella Cloud Firewall
##############################################################################################################

[FAKE:cisco:umbrella:firewall]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^"
MAX_TIMESTAMP_LOOKAHEAD = 21
TRUNCATE = 999999
# Umbrella Cloud Firewall CSV: 14 columns
FIELDALIAS-src_for_umbrella_fw = Source_IP AS src
FIELDALIAS-dest_for_umbrella_fw = Destination_IP AS dest
FIELDALIAS-action_for_umbrella_fw = Verdict AS action
EVAL-vendor_product = "Cisco Umbrella"
EVAL-app = "umbrella_firewall"


##############################################################################################################
# CISCO SECURE ACCESS - Umbrella Audit
##############################################################################################################

[FAKE:cisco:umbrella:audit]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^"","
MAX_TIMESTAMP_LOOKAHEAD = 21
TRUNCATE = 999999
# Umbrella Audit CSV: 9 columns, Time is 2nd field (after empty ID)
FIELDALIAS-user_for_umbrella_audit = Email AS user
FIELDALIAS-action_for_umbrella_audit = Action AS action
EVAL-vendor_product = "Cisco Umbrella"
EVAL-app = "umbrella_audit"


##############################################################################################################
# CISCO WEBEX - Events
##############################################################################################################

[FAKE:cisco:webex:events]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = "timestamp"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex"
EVAL-vendor = "Cisco"
EVAL-product = "Webex"
category = Collaboration
description = Cisco Webex device events for the FAKE tshirt company



##############################################################################################################
# CISCO WEBEX - Meetings TA (XML API)
##############################################################################################################

[FAKE:cisco:webex:meetings:history:meetingusagehistory]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = "meetingStartTime"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Meetings"
EVAL-vendor = "Cisco"
EVAL-product = "Webex Meetings"
category = Collaboration
description = Cisco Webex Meetings usage history for the FAKE tshirt company

[FAKE:cisco:webex:meetings:history:meetingattendeehistory]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %m/%d/%Y %H:%M:%S
TIME_PREFIX = "joinTime"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Meetings"
EVAL-vendor = "Cisco"
EVAL-product = "Webex Meetings"
category = Collaboration
description = Cisco Webex Meetings attendee history for the FAKE tshirt company


##############################################################################################################
# CISCO WEBEX - REST API
##############################################################################################################

[FAKE:cisco:webex:meetings]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "start"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Meetings API"
EVAL-vendor = "Cisco"
EVAL-product = "Webex"
category = Collaboration
description = Cisco Webex Meetings REST API data for the FAKE tshirt company

[FAKE:cisco:webex:admin:audit:events]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = "created"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Admin Audit"
EVAL-vendor = "Cisco"
EVAL-product = "Webex"
category = Collaboration
description = Cisco Webex Admin audit events for the FAKE tshirt company

[FAKE:cisco:webex:security:audit:events]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = "created"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Security Audit"
EVAL-vendor = "Cisco"
EVAL-product = "Webex"
category = Collaboration
description = Cisco Webex Security audit events for the FAKE tshirt company

[FAKE:cisco:webex:meeting:qualities]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = \"joinTime\": \"
MAX_TIMESTAMP_LOOKAHEAD = 24
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Meeting Quality"
EVAL-vendor = "Cisco"
EVAL-product = "Webex"
category = Collaboration
description = Cisco Webex meeting quality metrics for the FAKE tshirt company
DEPTH_LIMIT = 99999

[FAKE:cisco:webex:call:detailed_history]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%fZ
TIME_PREFIX = "Start time"\s*:\s*"
TRUNCATE = 999999
EVAL-vendor_product = "Cisco Webex Calling"
EVAL-vendor = "Cisco"
EVAL-product = "Webex Calling"
category = Collaboration
description = Cisco Webex Calling detailed history for the FAKE tshirt company


##############################################################################################################
# SERVICENOW
##############################################################################################################

[FAKE:servicenow:incident]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = auto
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S%Z
TIME_PREFIX = sys_updated_on=\"
MAX_TIMESTAMP_LOOKAHEAD = 20 
TRUNCATE = 999999
EVAL-vendor_product = "ServiceNow"
EVAL-vendor = "ServiceNow"
EVAL-product = "Incident Management"
# CIM field aliases for Ticket Management
FIELDALIAS-ticket_id = number AS ticket_id
FIELDALIAS-user = opened_by AS user
FIELDALIAS-status = state AS status
FIELDALIAS-priority_for_snow = priority AS severity
FIELDALIAS-description = short_description AS description
category = IT Service Management
description = ServiceNow incident records for the FAKE tshirt company


[FAKE:servicenow:cmdb]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = auto
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S%Z
TIME_PREFIX = sys_updated_on="
MAX_TIMESTAMP_LOOKAHEAD = 20
TRUNCATE = 999999
EVAL-vendor_product = "ServiceNow"
EVAL-vendor = "ServiceNow"
EVAL-product = "CMDB"
category = IT Service Management
description = ServiceNow CMDB configuration items for the FAKE tshirt company


[FAKE:servicenow:change]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
KV_MODE = auto
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S%Z
TIME_PREFIX = sys_updated_on="
MAX_TIMESTAMP_LOOKAHEAD = 20
TRUNCATE = 999999
EVAL-vendor_product = "ServiceNow"
EVAL-vendor = "ServiceNow"
EVAL-product = "Change Management"
# CIM field aliases for Ticket Management
FIELDALIAS-ticket_id_chg = number AS ticket_id
FIELDALIAS-status_chg = state AS status
category = IT Service Management
description = ServiceNow change request records for the FAKE tshirt company


##############################################################################################################
# DATABASE - Microsoft SQL Server Error Log
##############################################################################################################

[FAKE:mssql:errorlog]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)(?=\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{2})
TIME_FORMAT = %Y-%m-%d %H:%M:%S.%2N
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 22
TRUNCATE = 999999
# Compatible with Splunk Add-on for Microsoft SQL Server (sourcetype mssql:errorlog)
EVAL-vendor_product = "Microsoft SQL Server"
EVAL-vendor = "Microsoft"
EVAL-product = "SQL Server"
EVAL-dest = "SQL-PROD-01"
category = Database
description = Microsoft SQL Server Error Log for the FAKE tshirt company

#CIM - https://splunkbase.splunk.com/app/2648
REPORT-fields_for_backup = db_backup, db_backup_diff
REPORT-fields_for_login = logon_events_user,logon_events,logon_events_general
REPORT-fields_for_spid = spid_dbcc,spid_instance
REPORT-fields_for_server = server_general
REPORT-fields_for_errors = mssql_error_general
EVAL-app = "mssql"
EVAL-vendor_product = "Microsoft SQL Server"
EVAL-action = case(login_action=="succeeded", "success", login_action=="failed", "failure")
FIELDALIAS-dest = host AS dest
FIELDALIAS-src = src AS src_ip



##############################################################################################################
# ENDPOINT - Microsoft Sysmon (WinEventLog KV format)
##############################################################################################################

[FAKE:WinEventLog:Sysmon]
TRANSFORMS-demo_id = extract_demo_id_indexed
CHARSET = UTF-8
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)(?=\d{2}/\d{2}/\d{4}\s+\d{1,2}:\d{2}:\d{2}\s+(?:AM|PM))
TIME_FORMAT = %m/%d/%Y %I:%M:%S %p
TIME_PREFIX = ^
MAX_TIMESTAMP_LOOKAHEAD = 25
KV_MODE = AUTO
TRUNCATE = 99999

# Host extraction from ComputerName field
TRANSFORMS-set_host = set_host_from_wineventlog

# Extract fields from Message body (key: value pairs)
REPORT-sysmon_fields = extract_sysmon_image, extract_sysmon_commandline, extract_sysmon_user, extract_sysmon_parentimage, extract_sysmon_parentcommandline, extract_sysmon_targetfilename, extract_sysmon_targetobject, extract_sysmon_queryname, extract_sysmon_sourceip, extract_sysmon_destinationip, extract_sysmon_destinationport, extract_sysmon_protocol

# CIM-compatible field aliases
FIELDALIAS-signature_id = EventCode AS signature_id
FIELDALIAS-src = SourceIp AS src
FIELDALIAS-dest_ip = DestinationIp AS dest_ip
FIELDALIAS-process = Image AS process
FIELDALIAS-parent_process = ParentImage AS parent_process
EVAL-vendor_product = "Microsoft Sysmon"
EVAL-vendor = "Microsoft"
EVAL-product = "Sysmon"
category = Endpoint
description = Microsoft Sysmon operational events for the FAKE tshirt company


##############################################################################################################
# ERP
##############################################################################################################

[FAKE:sap:auditlog]
CHARSET = UTF-8
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = ^
TRUNCATE = 10000
TRANSFORMS-demo_id = extract_demo_id_indexed

# Field extractions  pipe-delimited format (all search-time via REPORT)
# Format: timestamp|host|dialog_type|user|tcode|status|description|document_number|details
REPORT-sap_fields = extract_sap_auditlog_fields
REPORT-sap_details = extract_sap_inventory, extract_sap_sales_order, extract_sap_amount, extract_sap_price_change, extract_sap_purchase_order, extract_sap_session, extract_sap_terminal, extract_sap_session_duration, extract_sap_login_failure

# CIM-compatible field aliases
FIELDALIAS-src_for_sap = host AS src
FIELDALIAS-action_for_sap = tcode AS action
FIELDALIAS-signature_for_sap = description AS signature
EVAL-vendor_product = "SAP S/4HANA"
EVAL-vendor = "SAP"
EVAL-product = "S/4HANA"
EVAL-app = "sap"
category = Application
description = SAP S/4HANA audit log events for the FAKE tshirt company

